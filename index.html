<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DanBeem Vibe Site</title>

  <style>
    :root{
      --bg:#070a16;
      --panel:rgba(255,255,255,0.07);
      --border:rgba(148,163,184,0.20);
      --text:#e5e7eb;
      --muted:rgba(229,231,235,0.70);
      --a:#38bdf8;
      --b:#a78bfa;
      --c:#22c55e;
      --shadow: 0 22px 80px rgba(0,0,0,0.55);
      --glass: rgba(6,8,26,0.55);
      --danger: #fb7185;
      --warn: #fbbf24;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 18% 0%, rgba(56,189,248,0.30), transparent 60%),
        radial-gradient(800px 500px at 90% 10%, rgba(167,139,250,0.22), transparent 55%),
        radial-gradient(900px 600px at 50% 120%, rgba(34,197,94,0.16), transparent 60%),
        linear-gradient(180deg, #070a16, #050615);
      overflow-x:hidden;
    }

    /* Scroll progress bar */
    .progress {
      position: fixed;
      top: 0;
      left: 0;
      height: 4px;
      width: 0%;
      background: linear-gradient(90deg, var(--a), var(--b), var(--c));
      z-index: 1000;
      box-shadow: 0 10px 30px rgba(56,189,248,0.25);
    }

    /* Cursor spotlight */
    .spotlight {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1;
      background: radial-gradient(260px 260px at var(--x) var(--y), rgba(56,189,248,0.14), transparent 70%);
      mix-blend-mode: screen;
      opacity: 1;
      transition: opacity 220ms ease;
    }
    body.reduce-motion .spotlight { opacity: 0.2; }

    /* Top nav */
    .nav{
      position:sticky;
      top:0;
      z-index: 100;
      backdrop-filter: blur(12px);
      background: var(--glass);
      border-bottom: 1px solid rgba(148,163,184,0.14);
    }
    .navInner{
      width:min(1100px, 94vw);
      margin:0 auto;
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      position: relative;
      z-index: 2;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 950;
      letter-spacing:0.02em;
    }
    .logo{
      width:38px;height:38px;border-radius:14px;
      display:grid;place-items:center;
      background: rgba(56,189,248,0.16);
      border:1px solid rgba(56,189,248,0.26);
      box-shadow: 0 12px 36px rgba(56,189,248,0.12);
    }
    .navBtns{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .linkBtn{
      border:1px solid rgba(148,163,184,0.20);
      background: rgba(255,255,255,0.05);
      color:var(--text);
      border-radius: 999px;
      padding: 8px 11px;
      font-size: 12px;
      font-weight: 900;
      cursor:pointer;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
    }
    .linkBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(56,189,248,0.35);
      background: rgba(255,255,255,0.07);
    }
    .linkBtn.active{
      border-color: rgba(56,189,248,0.55);
      box-shadow: 0 10px 30px rgba(56,189,248,0.10);
    }

    .toggles{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .toggle{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(148,163,184,0.18);
      background: rgba(255,255,255,0.05);
      font-size: 12px;
      font-weight: 900;
      color: rgba(229,231,235,0.85);
      cursor:pointer;
    }
    .toggle .dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: rgba(229,231,235,0.35);
      border: 1px solid rgba(148,163,184,0.20);
    }
    .toggle.on .dot{ background: linear-gradient(135deg, var(--a), var(--b)); border-color: rgba(56,189,248,0.35); }

    .wrap{
      width:min(1100px, 94vw);
      margin:0 auto;
      padding: 18px 0 80px;
      position: relative;
      z-index: 2;
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 12px;border-radius:999px;
      font-size:12px;font-weight:950;
      color: rgba(56,189,248,0.95);
      background: rgba(56,189,248,0.10);
      border:1px solid rgba(56,189,248,0.22);
      margin-bottom:10px;
    }

    h1{
      margin:0 0 10px;
      font-size: clamp(44px, 7vw, 92px);
      line-height: 0.95;
      letter-spacing: -0.02em;
    }
    h2{ margin: 0 0 10px; font-size: 22px; }
    p{ margin:0 0 12px; color:var(--muted); line-height:1.65; }

    /* HERO */
    .hero{
      height: 92vh;
      display:grid;
      place-items:center;
      border-radius: 28px;
      border:1px solid rgba(148,163,184,0.16);
      background:
        radial-gradient(900px 600px at 18% 20%, rgba(56,189,248,0.18), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(167,139,250,0.14), transparent 60%),
        rgba(255,255,255,0.04);
      overflow:hidden;
      position:relative;
    }
    .heroInner{
      text-align:center;
      padding: 26px 18px;
      position:relative;
      z-index:2;
    }
    .heroSmall{
      font-size: 14px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color: rgba(229,231,235,0.7);
      margin-bottom: 10px;
    }
    #heroBig{ font-weight: 950; transform-origin:center; }
    #heroSub{ max-width: 760px; margin: 14px auto 0; font-size: 16px; }
    .typeLine{
      margin-top: 10px;
      font-size: 13px;
      color: rgba(229,231,235,0.62);
      font-weight: 800;
      min-height: 18px;
    }
    .glowOrb{
      position:absolute;
      width: 520px; height: 520px;
      border-radius: 999px;
      filter: blur(42px);
      opacity: 0.45;
      z-index:1;
      background: radial-gradient(circle, rgba(56,189,248,0.55), transparent 60%);
      left: -120px; top: -140px;
      transform: translate3d(0,0,0);
    }
    .glowOrb.two{
      background: radial-gradient(circle, rgba(167,139,250,0.55), transparent 60%);
      left: auto; right: -160px; top: 40px;
      width: 560px; height: 560px;
      opacity:0.35;
    }
    body.chaos .glowOrb { animation: floaty 5.5s ease-in-out infinite; }
    body.chaos .glowOrb.two { animation: floaty2 6.8s ease-in-out infinite; }
    @keyframes floaty{ 0%,100%{ transform: translate(0,0) } 50%{ transform: translate(20px, 18px) } }
    @keyframes floaty2{ 0%,100%{ transform: translate(0,0) } 50%{ transform: translate(-22px, 14px) } }

    /* Buttons */
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top: 12px; }
    button{
      border:0;
      cursor:pointer;
      border-radius: 14px;
      padding: 12px 16px;
      font-weight: 950;
      font-size: 14px;
      color:#07111f;
      background: linear-gradient(135deg, rgba(56,189,248,1), rgba(167,139,250,0.95));
      box-shadow: 0 18px 55px rgba(56,189,248,0.18);
      transition: transform 120ms ease, filter 120ms ease;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    button.secondary{
      color:var(--text);
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(148,163,184,0.22);
      box-shadow:none;
    }

    /* Reveal animations */
    .reveal{
      opacity:0;
      transform: translateY(18px);
      transition: opacity 520ms ease, transform 520ms ease;
    }
    .reveal.show{
      opacity:1;
      transform: translateY(0);
    }
    body.reduce-motion .reveal{ opacity:1; transform:none; transition:none; }

    /* Carousel */
    .carouselWrap{ margin-top: 18px; position:relative; }
    .carousel{
      display:flex;
      gap: 14px;
      overflow-x:auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      padding: 6px 2px 10px;
      scrollbar-width: none;
    }
    .carousel::-webkit-scrollbar{ display:none; }
    .slide{
      flex: 0 0 86%;
      max-width: 86%;
      height: 340px;
      border-radius: 22px;
      overflow:hidden;
      scroll-snap-align: center;
      border:1px solid rgba(148,163,184,0.16);
      background: rgba(0,0,0,0.18);
      position:relative;
      transform-style: preserve-3d;
      transition: transform 180ms ease;
    }
    .slide img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      transform: scale(1.02);
    }
    .slideCap{
      position:absolute;
      left:14px; bottom:14px;
      padding: 8px 10px;
      border-radius: 14px;
      background: rgba(0,0,0,0.45);
      border:1px solid rgba(148,163,184,0.18);
      font-weight: 950;
      font-size: 12px;
    }
    .carBtns{ position:absolute; inset: 0; pointer-events:none; }
    .carBtn{
      pointer-events:auto;
      position:absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 44px; height: 44px;
      border-radius: 999px;
      border:1px solid rgba(148,163,184,0.22);
      background: rgba(0,0,0,0.35);
      color: var(--text);
      display:grid;
      place-items:center;
      cursor:pointer;
      backdrop-filter: blur(10px);
      user-select:none;
    }
    .carBtn:hover{ border-color: rgba(56,189,248,0.35); }
    .carBtn.left{ left: 8px; }
    .carBtn.right{ right: 8px; }
    .dots{ display:flex; gap:8px; justify-content:center; margin-top: 10px; }
    .dotBtn{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: rgba(229,231,235,0.22);
      border:1px solid rgba(148,163,184,0.18);
      cursor:pointer;
    }
    .dotBtn.active{
      background: rgba(56,189,248,0.85);
      border-color: rgba(56,189,248,0.30);
      box-shadow: 0 10px 30px rgba(56,189,248,0.10);
    }

    /* Sticky pinned section */
    .pin{
      margin-top: 18px;
      border-radius: 24px;
      border:1px solid rgba(148,163,184,0.16);
      background: rgba(255,255,255,0.04);
      overflow:hidden;
    }
    .pinInner{ height: 190vh; position:relative; }
    .pinSticky{ position: sticky; top: 74px; padding: 18px; }
    .pinCard{
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 14px;
      align-items: center;
      background: rgba(0,0,0,0.20);
      border: 1px solid rgba(148,163,184,0.16);
      border-radius: 22px;
      padding: 16px;
    }
    @media (max-width: 860px){
      .pinCard{ grid-template-columns: 1fr; }
      .slide{ height: 280px; }
    }
    .pinTitle{
      margin: 0 0 8px;
      font-size: 28px;
      line-height:1.1;
      letter-spacing:-0.01em;
    }
    .pinText{ margin:0; color: var(--muted); }
    .pinVisual{
      height: 260px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.16);
      background:
        radial-gradient(500px 300px at 20% 20%, rgba(56,189,248,0.22), transparent 60%),
        radial-gradient(500px 300px at 80% 30%, rgba(167,139,250,0.18), transparent 60%),
        rgba(255,255,255,0.03);
      display:grid;
      place-items:center;
      font-weight: 950;
      font-size: 16px;
      text-align:center;
      padding: 10px;
    }

    /* Cards for modules */
    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }
    .card{
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(148,163,184,0.16);
      border-radius: 20px;
      padding: 14px;
      box-shadow: 0 14px 45px rgba(0,0,0,0.28);
      transform-style: preserve-3d;
      transition: transform 160ms ease, border-color 160ms ease, background 160ms ease;
      position: relative;
      overflow:hidden;
      cursor: pointer;
    }
    .card:hover{
      border-color: rgba(56,189,248,0.30);
      background: rgba(255,255,255,0.06);
    }
    .card h3{ margin:0 0 6px; font-size: 16px; font-weight: 950; }
    .card p{ margin:0 0 10px; font-size: 13px; }

    /* App box */
    .box{
      border-radius: 18px;
      padding: 14px;
      border:1px solid rgba(148,163,184,0.16);
      background: rgba(0,0,0,0.18);
      margin-top: 12px;
    }
    .hidden{ display:none; }

    img.inline{
      width:100%;
      border-radius: 18px;
      border:1px solid rgba(148,163,184,0.16);
      display:block;
      margin-top: 12px;
    }

    input, textarea, select{
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.22);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }
    textarea{ width:100%; min-height: 90px; resize: vertical; }

    .bigNumber{
      font-size: 54px;
      font-weight: 950;
      letter-spacing: 0.02em;
      margin: 10px 0 6px;
      text-align:center;
    }
    .subtle{ font-size: 12px; color: rgba(229,231,235,0.55); text-align:center; }

    /* Toast */
    .toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 1001;
      display:flex;
      flex-direction: column;
      gap: 10px;
      width: min(360px, 92vw);
    }
    .toastItem{
      border-radius: 16px;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(148,163,184,0.18);
      padding: 12px 12px;
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 60px rgba(0,0,0,0.45);
      animation: toastIn 220ms ease;
    }
    @keyframes toastIn{
      from{ transform: translateY(10px); opacity: 0; }
      to{ transform: translateY(0); opacity: 1; }
    }
    .toastTitle{ font-weight: 950; margin:0 0 4px; font-size: 13px; }
    .toastMsg{ margin:0; font-size: 12px; color: rgba(229,231,235,0.75); line-height: 1.45; }

    /* Confetti */
    .confetti{
      position: fixed;
      inset: 0;
      pointer-events:none;
      z-index: 1002;
      overflow:hidden;
    }
    .confettiPiece{
      position:absolute;
      width: 10px;
      height: 14px;
      border-radius: 3px;
      opacity: 0.95;
      transform: translateY(-20px);
      animation: fall 900ms linear forwards;
    }
    @keyframes fall{
      to{
        transform: translateY(110vh) rotate(720deg);
        opacity: 0.9;
      }
    }

    /* Simple tab pills inside Chain Snapshot */
    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .tabBtn{
      border:1px solid rgba(148,163,184,0.18);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      cursor:pointer;
    }
    .tabBtn.active{
      background: linear-gradient(135deg, rgba(56,189,248,1), rgba(167,139,250,0.95));
      color:#07111f;
      border-color: transparent;
    }
    .resultBlock{
      border-radius: 16px;
      padding: 12px 12px;
      border:1px solid rgba(148,163,184,0.16);
      background: rgba(0,0,0,0.18);
      margin-top: 10px;
    }
    .resultBlock h4{ margin: 0 0 8px; font-size: 15px; }
    .resultBlock p, .resultBlock li{ color: var(--muted); font-size: 13px; line-height: 1.5; }
    .resultBlock ul{ margin: 0; padding-left: 18px; }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(148,163,184,0.18);
      color: rgba(229,231,235,0.75);
      font-size: 12px;
      font-weight: 900;
      background: rgba(0,0,0,0.25);
    }

    body.reduce-motion *{
      animation-duration: 1ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 1ms !important;
      scroll-behavior: auto !important;
    }
  </style>
</head>

<body>
  <div class="progress" id="progress"></div>
  <div class="spotlight" id="spotlight"></div>
  <div class="confetti" id="confetti"></div>
  <div class="toast" id="toast"></div>

  <div class="nav">
    <div class="navInner">
      <div class="brand">
        <div class="logo">‚ö°</div>
        <div>DanBeem</div>
      </div>

      <div class="navBtns">
        <button class="linkBtn" data-target="top" onclick="scrollToId('top')">Top</button>
        <button class="linkBtn" data-target="carousel" onclick="scrollToId('carousel')">Bread</button>
        <button class="linkBtn" data-target="pin" onclick="scrollToId('pin')">Scroll</button>
        <button class="linkBtn" data-target="apps" onclick="scrollToId('apps')">Apps</button>
      </div>

      <div class="toggles">
        <div class="toggle" id="motionToggle" onclick="toggleMotion()"><span class="dot"></span>Reduce motion</div>
        <div class="toggle" id="chaosToggle" onclick="toggleChaos()"><span class="dot"></span>Chaos</div>
      </div>
    </div>
  </div>

  <div class="wrap" id="top">
    <section class="hero">
      <div class="glowOrb" id="orb1"></div>
      <div class="glowOrb two" id="orb2"></div>

      <div class="heroInner">
        <div class="heroSmall">Live on GitHub Pages</div>
        <h1 id="heroBig">BREAD ENERGY</h1>
        <p id="heroSub">Scroll down for animations, carousel, sticky magic, and mini apps. All in one file. Now includes Chain Snapshot.</p>
        <div class="typeLine" id="typeLine"></div>
        <div class="btnRow">
          <button onclick="scrollToId('apps')">Open mini apps</button>
          <button class="secondary" onclick="scrollToId('carousel')">Show me bread</button>
        </div>
      </div>
    </section>

    <section id="carousel" class="panel reveal" style="margin-top:18px;">
      <div class="pill">Bread carousel</div>
      <h2>Swipe, arrows, dots, plus tilt</h2>
      <p>Upload bread1.jpg to bread6.jpg in the repo. Then enjoy irresponsible UI.</p>

      <div class="carouselWrap">
        <div class="carousel" id="car">
          <div class="slide tilt"><img src="bread1.jpg" alt="Bread 1"><div class="slideCap">bread1.jpg</div></div>
          <div class="slide tilt"><img src="bread2.jpg" alt="Bread 2"><div class="slideCap">bread2.jpg</div></div>
          <div class="slide tilt"><img src="bread3.jpg" alt="Bread 3"><div class="slideCap">bread3.jpg</div></div>
          <div class="slide tilt"><img src="bread4.jpg" alt="Bread 4"><div class="slideCap">bread4.jpg</div></div>
          <div class="slide tilt"><img src="bread5.jpg" alt="Bread 5"><div class="slideCap">bread5.jpg</div></div>
          <div class="slide tilt"><img src="bread6.jpg" alt="Bread 6"><div class="slideCap">bread6.jpg</div></div>
        </div>

        <div class="carBtns">
          <div class="carBtn left" onclick="carStep(-1)" aria-label="Previous">‚Äπ</div>
          <div class="carBtn right" onclick="carStep(1)" aria-label="Next">‚Ä∫</div>
        </div>
      </div>

      <div class="dots" id="dots" aria-label="Carousel dots"></div>
    </section>

    <section id="pin" class="pin reveal" style="margin-top:18px;">
      <div class="pinInner" id="pinInner">
        <div class="pinSticky">
          <div class="panel" style="box-shadow:none;">
            <div class="pill">Sticky scroll magic</div>
            <h2>Apple-ish pinned section</h2>
            <p>Scroll and watch the step text change. This is just math and a sticky container.</p>

            <div class="pinCard tilt">
              <div>
                <div class="pinTitle" id="pinTitle">Starter</div>
                <p class="pinText" id="pinText">Feed it. Name it. Respect it. It is alive.</p>
                <div class="btnRow" style="justify-content:flex-start;">
                  <button class="secondary" onclick="toast('Scroll magic', 'You are currently in the pinned section.')">Ping</button>
                  <button class="secondary" onclick="scrollToId('apps')">Jump to apps</button>
                </div>
              </div>
              <div class="pinVisual" id="pinVisual">Scroll down<br>to change steps</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="apps" class="panel reveal" style="margin-top:18px;">
      <div class="pill">Mini apps</div>
      <h2>Tools and toys</h2>
      <p>Pick a module. Chain Snapshot defaults to PBJ Advanced.</p>

      <div class="grid">
        <div class="card tilt" onclick="showApp('sourdough')">
          <h3>ü•ñ Sourdough Compliance</h3>
          <p>Users can choose Yes or choose Yes. Includes confetti.</p>
          <button onclick="event.stopPropagation(); showApp('sourdough')">Open</button>
        </div>

        <div class="card tilt" onclick="showApp('dad')">
          <h3>üòÑ Dad Joke Generator</h3>
          <p>One click jokes. Copy button. Toast feedback.</p>
          <button onclick="event.stopPropagation(); showApp('dad')">Open</button>
        </div>

        <div class="card tilt" onclick="showApp('timer')">
          <h3>‚è≤Ô∏è Bread Timer</h3>
          <p>Presets, custom time, beep, and title countdown.</p>
          <button onclick="event.stopPropagation(); showApp('timer')">Open</button>
        </div>

        <div class="card tilt" onclick="showApp('prompt')">
          <h3>üß† Prompt Builder</h3>
          <p>Generate a research prompt you paste into ChatGPT.</p>
          <button onclick="event.stopPropagation(); showApp('prompt')">Open</button>
        </div>

        <div class="card tilt" onclick="showApp('chain')">
          <h3>üß© Chain Snapshot</h3>
          <p>CCN lookup: facility summary, chain staffing, resident rights tags, PBJ HPRD math.</p>
          <button onclick="event.stopPropagation(); showApp('chain')">Open</button>
        </div>
      </div>

      <div id="appHome" class="box">
        Pick a module above.
      </div>

      <div id="appSourdough" class="box hidden">
        <h2>Important Question</h2>
        <p>Are you interested in learning about Dan‚Äôs love of sourdough bread?</p>

        <div id="sd1" class="btnRow">
          <button onclick="sdYes()">Yes</button>
          <button class="secondary" onclick="sdNo()">No</button>
        </div>

        <div id="sd2" class="hidden">
          <p>Let‚Äôs revisit this. Starter care, hydration ratios, cold retard timing, unsolicited bread facts.</p>
          <div class="btnRow"><button onclick="sdYes()">Yes</button></div>
        </div>

        <div id="sd3" class="hidden">
          <h2>Welcome to the Crumb Zone</h2>
          <p>Sourdough is a responsibility.</p>
          <img class="inline" src="sourdough_hero_loaf.jpg" alt="Hero loaf">
          <div class="btnRow">
            <button class="secondary" onclick="resetSourdough()">Restart</button>
            <button onclick="toast('Bread', 'Thank you for accepting your fate.')">Toast</button>
          </div>
        </div>
      </div>

      <div id="appDad" class="box hidden">
        <h2>Dad Joke Generator</h2>
        <p>Press generate. Copy. Become a menace.</p>
        <div class="btnRow">
          <button onclick="newJoke()">Generate</button>
          <button class="secondary" onclick="copyJoke()">Copy</button>
        </div>
        <div class="box" style="margin-top:10px;">
          <div style="font-weight:950; font-size:12px; color:rgba(229,231,235,0.65);">Joke</div>
          <div id="jokeText" style="font-size:18px;font-weight:950;margin-top:6px;">Click Generate.</div>
        </div>
      </div>

      <div id="appTimer" class="box hidden">
        <h2>Bread Timer</h2>
        <p>Presets or custom. Beep when done. Title updates.</p>

        <div class="btnRow" style="justify-content:flex-start;">
          <label style="color:var(--muted); font-size:12px;">Preset</label>
          <select id="preset" onchange="applyPreset()">
            <option value="">Choose one</option>
            <option value="20:00">Preheat (20:00)</option>
            <option value="45:00">Bake covered (45:00)</option>
            <option value="15:00">Bake uncovered (15:00)</option>
            <option value="30:00">Proof check (30:00)</option>
          </select>
        </div>

        <div class="btnRow" style="justify-content:flex-start;">
          <label style="color:var(--muted); font-size:12px;">Set time</label>
          <input id="mins" type="number" min="0" placeholder="min" style="width:100px;">
          <input id="secs" type="number" min="0" max="59" placeholder="sec" style="width:100px;">
          <button class="secondary" onclick="setFromInputs()">Set</button>
        </div>

        <div class="bigNumber" id="timerDisplay">00:00</div>
        <div class="subtle" id="timerStatus">Not running</div>

        <div class="btnRow">
          <button onclick="startTimer()">Start</button>
          <button class="secondary" onclick="pauseTimer()">Pause</button>
          <button class="secondary" onclick="resetTimer()">Reset</button>
        </div>
      </div>

      <div id="appPrompt" class="box hidden">
        <h2>Prompt Builder</h2>
        <p>Fill a few fields. Copy a structured prompt. Paste into ChatGPT.</p>

        <div class="box">
          <div style="display:grid; gap:10px;">
            <input id="pbTopic" placeholder="Topic (example: CMS nursing home quality measures)" />
            <input id="pbGoal" placeholder="Goal (example: summarize key risks and action items)" />
            <input id="pbConstraints" placeholder="Constraints (example: cite sources, keep it plain language)" />
            <textarea id="pbContext" placeholder="Optional context you already know or want included"></textarea>
            <div class="btnRow" style="justify-content:flex-start;">
              <button onclick="buildPrompt()">Build</button>
              <button class="secondary" onclick="copyBuiltPrompt()">Copy</button>
              <button class="secondary" onclick="toast('Prompt Builder', 'Pro tip: keep prompts short and repeatable.')">Tip</button>
            </div>
          </div>
        </div>

        <div class="box" style="margin-top:12px;">
          <div style="font-weight:950; font-size:12px; color:rgba(229,231,235,0.65);">Generated prompt</div>
          <textarea id="pbOutput" readonly style="margin-top:8px; min-height:140px;"></textarea>
        </div>
      </div>

      <!-- Chain Snapshot (merged in) -->
      <div id="appChain" class="box hidden">
        <h2>Chain Snapshot</h2>
        <p>Enter a CCN, run it, then switch tabs. Defaults to PBJ Advanced.</p>

        <div class="btnRow" style="justify-content:flex-start;">
          <label style="color:var(--muted); font-size:12px;">CCN</label>
          <input id="csCcn" type="text" placeholder="e.g. 123456" style="width:160px;">
          <span class="badge" id="csStatus">Awaiting query</span>
          <button onclick="csRun()">Run</button>
          <button class="secondary" onclick="csClear()">Clear</button>
        </div>

        <div class="tabs" role="tablist" aria-label="Chain Snapshot tabs">
          <button class="tabBtn" id="csTabSummary" onclick="csSetTab('summary')">Summary</button>
          <button class="tabBtn" id="csTabRights" onclick="csSetTab('rights')">Resident Rights F Tags</button>
          <button class="tabBtn" id="csTabPbj" onclick="csSetTab('pbj')">PBJ Advanced</button>
        </div>

        <div id="csPanelSummary">
          <div class="resultBlock" id="csFacility">
            <h4>Facility Summary</h4>
            <p>Run a CCN to populate details.</p>
          </div>
          <div class="resultBlock" id="csChain">
            <h4>Chain Summary</h4>
            <p>Chain details will appear here when available.</p>
          </div>
        </div>

        <div id="csPanelRights" class="hidden">
          <div class="resultBlock">
            <h4>Resident Rights F Tags (newest 25)</h4>
            <ul id="csRightsList">
              <li>Run a CCN to populate results.</li>
            </ul>
          </div>
        </div>

        <div id="csPanelPbj" class="hidden">
          <div class="resultBlock">
            <h4>PBJ Daily Nurse Staffing</h4>
            <div class="btnRow" style="justify-content:flex-start;">
              <label style="color:var(--muted); font-size:12px;">Start</label>
              <input id="csPbjStart" type="date">
              <label style="color:var(--muted); font-size:12px;">End</label>
              <input id="csPbjEnd" type="date">
              <button class="secondary" onclick="csRun()">Run</button>
            </div>
            <div id="csPbjResults">
              <p>Choose a date range and run to see PBJ totals.</p>
            </div>
          </div>

          <div class="resultBlock">
            <h4>Notes</h4>
            <p>This uses the CMS data.cms.gov catalog and tries to locate datasets by title. If CMS changes dataset titles or disables CORS, this may fail gracefully.</p>
          </div>
        </div>
      </div>

      <div class="btnRow" style="margin-top:14px;">
        <button class="secondary" onclick="showApp('apps')">Close modules</button>
      </div>
    </section>

    <div class="subtle" style="margin-top:16px;">
      Over the top mode achieved. Still a single index.html.
    </div>
  </div>

  <script>
    // Progress bar
    const progress = document.getElementById("progress");
    function updateProgress(){
      const h = document.documentElement;
      const sc = h.scrollTop || document.body.scrollTop;
      const max = (h.scrollHeight - h.clientHeight) || 1;
      const pct = (sc / max) * 100;
      progress.style.width = pct + "%";
    }
    window.addEventListener("scroll", updateProgress, {passive:true});
    window.addEventListener("resize", updateProgress);
    updateProgress();

    // Spotlight follows pointer
    function setSpot(x, y){
      document.documentElement.style.setProperty("--x", x + "px");
      document.documentElement.style.setProperty("--y", y + "px");
    }
    window.addEventListener("pointermove", (e)=> setSpot(e.clientX, e.clientY), {passive:true});
    setSpot(window.innerWidth/2, window.innerHeight/3);

    // Nav active based on scroll position
    const navButtons = Array.from(document.querySelectorAll(".linkBtn"));
    const targets = navButtons.map(b => document.getElementById(b.dataset.target)).filter(Boolean);
    const navIO = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{
        if(e.isIntersecting){
          navButtons.forEach(b => b.classList.toggle("active", b.dataset.target === e.target.id));
        }
      });
    }, { threshold: 0.35 });
    targets.forEach(t => navIO.observe(t));

    function scrollToId(id){
      const el = document.getElementById(id);
      if(!el) return;
      el.scrollIntoView({behavior:"smooth", block:"start"});
    }

    // Helpers
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

    // Hero scroll effect plus orbs
    const heroBig = document.getElementById("heroBig");
    const heroSub = document.getElementById("heroSub");
    const orb1 = document.getElementById("orb1");
    const orb2 = document.getElementById("orb2");

    function heroScroll(){
      const sc = window.scrollY || 0;
      const p = clamp(sc / window.innerHeight, 0, 1.2);
      const scale = 1 + p * 0.55;
      const blur = p * 6;
      const op = 1 - p * 0.35;

      heroBig.style.transform = `scale(${scale})`;
      heroBig.style.filter = `blur(${blur}px)`;
      heroBig.style.opacity = `${op}`;

      heroSub.style.transform = `translateY(${p*16}px)`;
      heroSub.style.opacity = `${1 - p*0.55}`;

      if(!document.body.classList.contains("chaos")){
        orb1.style.transform = `translate(${sc*0.06}px, ${sc*0.04}px)`;
        orb2.style.transform = `translate(${sc*-0.04}px, ${sc*0.05}px)`;
      }
    }
    window.addEventListener("scroll", heroScroll, {passive:true});
    window.addEventListener("resize", heroScroll);
    heroScroll();

    // Typewriter line
    const typeLine = document.getElementById("typeLine");
    const typeText = "This site contains bread, jokes, timers, prompts, irresponsible UI, and a Chain Snapshot for CMS data.";
    let ti = 0;
    function typeTick(){
      if(document.body.classList.contains("reduce-motion")){ typeLine.textContent = typeText; return; }
      typeLine.textContent = typeText.slice(0, ti);
      ti += 1;
      if(ti <= typeText.length) setTimeout(typeTick, 18);
    }
    typeTick();

    // Reveal on scroll
    const reveals = document.querySelectorAll(".reveal");
    const io = new IntersectionObserver((entries)=>{
      for(const e of entries){
        if(e.isIntersecting) e.target.classList.add("show");
      }
    }, { threshold: 0.14 });
    reveals.forEach(r => io.observe(r));

    // Tilt effect
    function attachTilt(el){
      if(!el) return;
      el.addEventListener("pointermove", (e)=>{
        if(document.body.classList.contains("reduce-motion")) return;
        const r = el.getBoundingClientRect();
        const px = (e.clientX - r.left) / r.width;
        const py = (e.clientY - r.top) / r.height;
        const rx = (py - 0.5) * -10;
        const ry = (px - 0.5) * 10;
        el.style.transform = `perspective(900px) rotateX(${rx}deg) rotateY(${ry}deg) translateY(-2px)`;
      });
      el.addEventListener("pointerleave", ()=>{ el.style.transform = ""; });
    }
    document.querySelectorAll(".tilt").forEach(attachTilt);

    // Carousel dots and stepping
    const car = document.getElementById("car");
    const dotsWrap = document.getElementById("dots");
    const slides = Array.from(car.querySelectorAll(".slide"));
    slides.forEach((_, i)=>{
      const d = document.createElement("button");
      d.className = "dotBtn" + (i===0 ? " active" : "");
      d.setAttribute("aria-label", `Go to slide ${i+1}`);
      d.addEventListener("click", ()=> goToSlide(i));
      dotsWrap.appendChild(d);
    });
    function getActiveIndex(){
      const left = car.scrollLeft;
      let best = 0;
      let bestDist = Infinity;
      slides.forEach((s, i)=>{
        const dist = Math.abs(s.offsetLeft - left);
        if(dist < bestDist){ bestDist = dist; best = i; }
      });
      return best;
    }
    function setDot(i){
      const dots = Array.from(dotsWrap.children);
      dots.forEach((d, idx)=> d.classList.toggle("active", idx===i));
    }
    function goToSlide(i){
      slides[i].scrollIntoView({behavior:"smooth", inline:"center", block:"nearest"});
      setDot(i);
    }
    function carStep(dir){
      const i = getActiveIndex();
      const next = clamp(i + dir, 0, slides.length - 1);
      goToSlide(next);
    }
    car.addEventListener("scroll", ()=>{
      window.clearTimeout(car._t);
      car._t = window.setTimeout(()=> setDot(getActiveIndex()), 80);
    }, {passive:true});

    // Sticky text swap
    const pinInner = document.getElementById("pinInner");
    const pinTitle = document.getElementById("pinTitle");
    const pinText = document.getElementById("pinText");
    const pinVisual = document.getElementById("pinVisual");
    const steps = [
      { t:"Starter", d:"Feed it. Name it. Respect it. It is alive.", v:"Step 1<br>Starter" },
      { t:"Mix", d:"Flour, water, salt. Stir until chaos becomes dough.", v:"Step 2<br>Mix" },
      { t:"Fold", d:"Gentle folds. Every 30 minutes. Like bread yoga.", v:"Step 3<br>Folds" },
      { t:"Cold Retard", d:"The schedule saver. The flavor multiplier. The legend.", v:"Step 4<br>Cold retard" },
      { t:"Bake", d:"Steam, heat, and the moment of truth.", v:"Step 5<br>Bake" },
    ];
    function pinScroll(){
      const r = pinInner.getBoundingClientRect();
      const total = r.height - window.innerHeight;
      const progressed = clamp((window.innerHeight - r.top) / total, 0, 1);
      const idx = clamp(Math.floor(progressed * steps.length), 0, steps.length - 1);
      pinTitle.innerHTML = steps[idx].t;
      pinText.innerHTML = steps[idx].d;
      pinVisual.innerHTML = steps[idx].v;
    }
    window.addEventListener("scroll", pinScroll, {passive:true});
    window.addEventListener("resize", pinScroll);
    pinScroll();

    // Motion and chaos toggles
    const motionToggle = document.getElementById("motionToggle");
    const chaosToggle = document.getElementById("chaosToggle");
    function toggleMotion(){
      document.body.classList.toggle("reduce-motion");
      motionToggle.classList.toggle("on");
      toast("Motion", document.body.classList.contains("reduce-motion") ? "Reduced motion enabled." : "Reduced motion disabled.");
    }
    function toggleChaos(){
      document.body.classList.toggle("chaos");
      chaosToggle.classList.toggle("on");
      toast("Chaos", document.body.classList.contains("chaos") ? "Chaos enabled." : "Chaos disabled.");
    }

    // Toast system
    const toastWrap = document.getElementById("toast");
    function escapeHtml(s){
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }
    function toast(title, msg){
      const t = document.createElement("div");
      t.className = "toastItem";
      t.innerHTML = `<div class="toastTitle">${escapeHtml(title)}</div><p class="toastMsg">${escapeHtml(msg)}</p>`;
      toastWrap.appendChild(t);
      setTimeout(()=>{ t.style.opacity = "0"; t.style.transform = "translateY(6px)"; }, 2200);
      setTimeout(()=>{ t.remove(); }, 2600);
    }

    // Confetti burst
    const confetti = document.getElementById("confetti");
    function confettiBurst(){
      if(document.body.classList.contains("reduce-motion")) return;
      const colors = ["#38bdf8","#a78bfa","#22c55e","#fbbf24","#fb7185"];
      for(let i=0;i<34;i++){
        const p = document.createElement("div");
        p.className = "confettiPiece";
        p.style.left = Math.random()*100 + "vw";
        p.style.background = colors[Math.floor(Math.random()*colors.length)];
        p.style.animationDuration = (700 + Math.random()*700) + "ms";
        p.style.width = (8 + Math.random()*10) + "px";
        p.style.height = (10 + Math.random()*12) + "px";
        confetti.appendChild(p);
        setTimeout(()=> p.remove(), 1400);
      }
    }

    // Mini apps show/hide
    const appHome = document.getElementById("appHome");
    const appSourdough = document.getElementById("appSourdough");
    const appDad = document.getElementById("appDad");
    const appTimer = document.getElementById("appTimer");
    const appPrompt = document.getElementById("appPrompt");
    const appChain = document.getElementById("appChain");

    function showApp(which){
      appHome.classList.add("hidden");
      appSourdough.classList.add("hidden");
      appDad.classList.add("hidden");
      appTimer.classList.add("hidden");
      appPrompt.classList.add("hidden");
      appChain.classList.add("hidden");

      if(which === "apps"){
        appHome.classList.remove("hidden");
        resetSourdough();
        stopIntervalOnly();
        toast("Modules", "Closed. Choose another module.");
      }
      if(which === "sourdough"){
        appSourdough.classList.remove("hidden");
        stopIntervalOnly();
        resetSourdough();
        toast("Sourdough", "Compliance required.");
      }
      if(which === "dad"){
        appDad.classList.remove("hidden");
        stopIntervalOnly();
        toast("Dad Jokes", "Your fate is sealed.");
      }
      if(which === "timer"){
        appTimer.classList.remove("hidden");
        toast("Timer", "Set your bake schedule.");
      }
      if(which === "prompt"){
        appPrompt.classList.remove("hidden");
        stopIntervalOnly();
        toast("Prompt Builder", "Build a reusable research prompt.");
      }
      if(which === "chain"){
        appChain.classList.remove("hidden");
        stopIntervalOnly();
        csSetTab("pbj");
        toast("Chain Snapshot", "Defaults to PBJ Advanced.");
      }
      scrollToId("apps");
    }

    // Sourdough app
    function sdNo(){
      document.getElementById("sd1").classList.add("hidden");
      document.getElementById("sd2").classList.remove("hidden");
      toast("Question", "Incorrect choice detected.");
    }
    function sdYes(){
      document.getElementById("sd1").classList.add("hidden");
      document.getElementById("sd2").classList.add("hidden");
      document.getElementById("sd3").classList.remove("hidden");
      toast("Bread accepted", "Welcome to the Crumb Zone.");
      confettiBurst();
    }
    function resetSourdough(){
      const a = document.getElementById("sd1");
      const b = document.getElementById("sd2");
      const c = document.getElementById("sd3");
      if(!a || !b || !c) return;
      a.classList.remove("hidden");
      b.classList.add("hidden");
      c.classList.add("hidden");
    }

    // Dad jokes
    const dadJokes = [
      "I used to hate facial hair, but then it grew on me.",
      "I‚Äôm reading a book about anti gravity. It‚Äôs impossible to put down.",
      "I don‚Äôt trust stairs. They‚Äôre always up to something.",
      "What do you call fake spaghetti? An impasta.",
      "I only know 25 letters of the alphabet. I don‚Äôt know y.",
      "How do you organize a space party? You planet.",
      "Why don‚Äôt eggs tell jokes? They‚Äôd crack each other up.",
      "I used to play piano by ear. Now I use my hands.",
      "I told my wife she should embrace her mistakes. She hugged me.",
      "I ordered a chicken and an egg online. I‚Äôll let you know."
    ];
    function newJoke(){
      const i = Math.floor(Math.random()*dadJokes.length);
      document.getElementById("jokeText").textContent = dadJokes[i];
      toast("Dad Joke", "Generated.");
    }
    async function copyJoke(){
      const t = document.getElementById("jokeText").textContent || "";
      if(!t.trim()) return;
      try{
        await navigator.clipboard.writeText(t);
        toast("Copied", "Joke copied to clipboard.");
      }catch{
        alert("Copy failed on this device. Press and hold to copy manually.");
      }
    }

    // Timer
    let timerTotalSeconds = 0;
    let timerRemainingSeconds = 0;
    let timerInterval = null;

    function formatTime(s){
      const mm = String(Math.floor(s/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      return `${mm}:${ss}`;
    }
    function setDisplay(){
      document.getElementById("timerDisplay").textContent = formatTime(timerRemainingSeconds);
      document.title = timerInterval ? `‚è≤Ô∏è ${formatTime(timerRemainingSeconds)} DanBeem` : "DanBeem Vibe Site";
    }
    function setTimerStatus(t){
      document.getElementById("timerStatus").textContent = t;
    }
    function applyPreset(){
      const val = document.getElementById("preset").value;
      if(!val) return;
      const [m,s] = val.split(":");
      timerTotalSeconds = (Number(m||0)*60) + Number(s||0);
      timerRemainingSeconds = timerTotalSeconds;
      setDisplay();
      setTimerStatus("Ready");
      toast("Timer", "Preset loaded.");
    }
    function setFromInputs(){
      const mm = Number(document.getElementById("mins").value||0);
      const ss = clamp(Number(document.getElementById("secs").value||0), 0, 59);
      timerTotalSeconds = (Math.max(mm,0)*60) + ss;
      timerRemainingSeconds = timerTotalSeconds;
      setDisplay();
      setTimerStatus("Ready");
      toast("Timer", "Custom time set.");
    }
    function startTimer(){
      if(timerRemainingSeconds <= 0){ setTimerStatus("Set a time first"); toast("Timer", "Set a time first."); return; }
      if(timerInterval) return;
      setTimerStatus("Running");
      toast("Timer", "Started.");
      timerInterval = setInterval(()=>{
        timerRemainingSeconds -= 1;
        if(timerRemainingSeconds <= 0){
          timerRemainingSeconds = 0;
          setDisplay();
          stopIntervalOnly();
          setTimerStatus("Done");
          beep();
          confettiBurst();
          toast("Timer done", "Bread time.");
          alert("Timer done!");
          return;
        }
        setDisplay();
      }, 1000);
    }
    function pauseTimer(){
      if(!timerInterval) return;
      stopIntervalOnly();
      setTimerStatus("Paused");
      toast("Timer", "Paused.");
    }
    function resetTimer(){
      stopIntervalOnly();
      timerRemainingSeconds = timerTotalSeconds;
      setDisplay();
      setTimerStatus("Ready");
      toast("Timer", "Reset.");
    }
    function stopIntervalOnly(){
      if(timerInterval){
        clearInterval(timerInterval);
        timerInterval = null;
        document.title = "DanBeem Vibe Site";
      }
    }
    function beep(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.value = 880;
        gain.gain.value = 0.05;
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        setTimeout(()=>{ osc.stop(); ctx.close(); }, 220);
      }catch{}
    }
    setDisplay();

    // Prompt builder
    function buildPrompt(){
      const topic = (document.getElementById("pbTopic").value || "").trim();
      const goal = (document.getElementById("pbGoal").value || "").trim();
      const constraints = (document.getElementById("pbConstraints").value || "").trim();
      const context = (document.getElementById("pbContext").value || "").trim();

      const prompt =
`You are my research assistant. I am building a quick, accurate brief.

Topic:
${topic || "Unspecified topic"}

Goal:
${goal || "Provide a structured summary and next steps."}

Constraints:
${constraints || "Use clear plain language. Provide citations where possible. Be practical and specific."}

Context I already have:
${context || "None provided."}

Output format:
1) Key facts (bullets)
2) What matters and why (short paragraphs)
3) Risks and unknowns
4) Recommended next steps
5) Questions I should answer next`;

      document.getElementById("pbOutput").value = prompt;
      toast("Prompt Builder", "Prompt generated.");
    }

    async function copyBuiltPrompt(){
      const t = document.getElementById("pbOutput").value || "";
      if(!t.trim()){ toast("Prompt Builder", "Nothing to copy yet."); return; }
      try{
        await navigator.clipboard.writeText(t);
        toast("Copied", "Prompt copied to clipboard.");
      }catch{
        alert("Copy failed on this device. Press and hold to copy manually.");
      }
    }

    /* =========================
       Chain Snapshot (merged)
       ========================= */

    const csEls = {
      ccn: document.getElementById("csCcn"),
      status: document.getElementById("csStatus"),
      facility: document.getElementById("csFacility"),
      chain: document.getElementById("csChain"),
      rights: document.getElementById("csRightsList"),
      pbjStart: document.getElementById("csPbjStart"),
      pbjEnd: document.getElementById("csPbjEnd"),
      pbjResults: document.getElementById("csPbjResults"),
      tabSummary: document.getElementById("csTabSummary"),
      tabRights: document.getElementById("csTabRights"),
      tabPbj: document.getElementById("csTabPbj"),
      panelSummary: document.getElementById("csPanelSummary"),
      panelRights: document.getElementById("csPanelRights"),
      panelPbj: document.getElementById("csPanelPbj"),
    };

    const csDatasetCache = new Map();
    const csDatasetUrlCache = new Map();

    function csNormalizeCcn(v){ return String(v || "").trim(); }

    function csSetStatus(text){
      csEls.status.textContent = text;
    }

    function csSetTab(which){
      const isSummary = which === "summary";
      const isRights = which === "rights";
      const isPbj = which === "pbj";

      csEls.tabSummary.classList.toggle("active", isSummary);
      csEls.tabRights.classList.toggle("active", isRights);
      csEls.tabPbj.classList.toggle("active", isPbj);

      csEls.panelSummary.classList.toggle("hidden", !isSummary);
      csEls.panelRights.classList.toggle("hidden", !isRights);
      csEls.panelPbj.classList.toggle("hidden", !isPbj);
    }
    csSetTab("pbj"); // default state even before opening

    function csGetFirstValue(row, fields){
      for (const field of fields){
        if (row && row[field] !== undefined && row[field] !== null && row[field] !== ""){
          return row[field];
        }
      }
      return null;
    }

    async function csFetchDatasetCatalog(){
      if (csDatasetCache.has("catalog")) return csDatasetCache.get("catalog");
      const response = await fetch("https://data.cms.gov/data.json");
      if(!response.ok) throw new Error("Failed to load CMS catalog.");
      const data = await response.json();
      csDatasetCache.set("catalog", data);
      return data;
    }

    async function csFindDatasetUrl(title){
      if (csDatasetUrlCache.has(title)) return csDatasetUrlCache.get(title);

      const catalog = await csFetchDatasetCatalog();
      const dataset = (catalog.dataset || []).find((entry) => entry.title === title);
      if (!dataset) return null;

      const distribution = dataset.distribution || [];
      const access =
        distribution.find((item) => item.accessURL)?.accessURL ||
        distribution.find((item) => item.downloadURL)?.downloadURL ||
        distribution[0]?.accessURL ||
        distribution[0]?.downloadURL ||
        null;

      if (access) csDatasetUrlCache.set(title, access);
      return access;
    }

    async function csFetchJson(url){
      if(!url) return [];
      const response = await fetch(url);
      if(!response.ok) throw new Error("Request failed.");
      return response.json();
    }

    function csBuildSocrataUrl(baseUrl, params){
      if(!baseUrl) return null;
      const url = new URL(baseUrl);
      Object.entries(params).forEach(([key, value])=>{
        if (value !== null && value !== undefined && value !== "") url.searchParams.set(key, value);
      });
      return url.toString();
    }

    function csFormatStars(value){
      if (value === null || value === undefined || value === "") return "Not reported";
      return `${value} ‚òÖ`;
    }

    function csFormatAddress(row){
      const street = csGetFirstValue(row, ["address", "street_address", "provider_address", "provider_address_1"]);
      const city = csGetFirstValue(row, ["city", "provider_city"]);
      const state = csGetFirstValue(row, ["state", "provider_state"]);
      const zip = csGetFirstValue(row, ["zip", "zip_code", "provider_zip_code", "provider_zip"]);
      return [street, city, state, zip].filter(Boolean).join(", ");
    }

    function csRenderFacilitySummary(row){
      if (!row){
        csEls.facility.innerHTML = "<h4>Facility Summary</h4><p>No facility found for that CCN.</p>";
        return;
      }
      const name = csGetFirstValue(row, ["provider_name", "facility_name", "name"]);
      const overall = csFormatStars(csGetFirstValue(row, ["overall_rating", "overall_star_rating", "overall_rating_value"]));
      const staffing = csFormatStars(csGetFirstValue(row, ["staffing_rating", "staffing_star_rating"]));
      const health = csFormatStars(csGetFirstValue(row, ["health_inspection_rating", "health_inspection_star_rating"]));
      const quality = csFormatStars(csGetFirstValue(row, ["quality_measure_rating", "quality_star_rating", "quality_measure_star_rating"]));
      const rnHprd = csGetFirstValue(row, ["rn_hours_per_resident_day", "rn_hprd"]);
      const totalHprd = csGetFirstValue(row, ["total_nurse_hours_per_resident_day", "total_nurse_hprd"]);

      csEls.facility.innerHTML = `
        <h4>Facility Summary</h4>
        <p><strong>${escapeHtml(name || "Unknown facility")}</strong></p>
        <p>${escapeHtml(csFormatAddress(row) || "Address not available")}</p>
        <p>Overall rating: ${escapeHtml(overall)}</p>
        <p>Staffing rating: ${escapeHtml(staffing)}</p>
        <p>Health inspection rating: ${escapeHtml(health)}</p>
        <p>Quality measure rating: ${escapeHtml(quality)}</p>
        <p>RN hours per resident day: ${escapeHtml(rnHprd ?? "Not reported")}</p>
        <p>Total nurse hours per resident day: ${escapeHtml(totalHprd ?? "Not reported")}</p>
      `;
    }

    function csRenderChainSummary(row){
      if (!row){
        csEls.chain.innerHTML = "<h4>Chain Summary</h4><p>No chain data available.</p>";
        return;
      }
      const chainName = csGetFirstValue(row, ["chain_name", "affiliated_entity_name", "organization_name"]);
      const chainStaffing = csGetFirstValue(row, ["average_staffing_rating", "chain_avg_staffing_rating", "average_staffing_star_rating"]);
      csEls.chain.innerHTML = `
        <h4>Chain Summary</h4>
        <p><strong>${escapeHtml(chainName || "Unknown chain")}</strong></p>
        <p>Chain average staffing: ${escapeHtml(chainStaffing ?? "Not reported")}</p>
      `;
    }

    function csRenderRights(items){
      if (!items || items.length === 0){
        csEls.rights.innerHTML = "<li>No Resident Rights tags found.</li>";
        return;
      }
      csEls.rights.innerHTML = items.map((item)=>{
        const tag = csGetFirstValue(item, ["f_tag", "tag_code", "deficiency_tag"]);
        const date = csGetFirstValue(item, ["survey_date", "deficiency_date", "inspection_date", "date"]);
        const scope = csGetFirstValue(item, ["scope_severity", "scope_severity_code"]);
        const description = csGetFirstValue(item, ["deficiency_description", "description"]);
        return `<li><strong>${escapeHtml(tag || "Tag")}:</strong> ${escapeHtml(date || "Unknown date")} | ${escapeHtml(scope || "Scope n/a")}<br>${escapeHtml(description || "Description unavailable.")}</li>`;
      }).join("");
    }

    function csRenderPbjResults(payload){
      csEls.pbjResults.innerHTML = `
        <p>Days included: ${payload.days}</p>
        <p>Total census: ${payload.totalCensus}</p>
        <p>RN hours: ${payload.totalRn}</p>
        <p>LPN hours: ${payload.totalLpn}</p>
        <p>CNA hours: ${payload.totalCna}</p>
        <p><strong>Total nursing HPRD:</strong> ${payload.hprd}</p>
      `;
    }

    function csClear(){
      csEls.ccn.value = "";
      csSetStatus("Awaiting query");
      csEls.facility.innerHTML = "<h4>Facility Summary</h4><p>Run a CCN to populate details.</p>";
      csEls.chain.innerHTML = "<h4>Chain Summary</h4><p>Chain details will appear here when available.</p>";
      csEls.rights.innerHTML = "<li>Run a CCN to populate results.</li>";
      csEls.pbjResults.innerHTML = "<p>Choose a date range and run to see PBJ totals.</p>";
      toast("Chain Snapshot", "Cleared.");
    }

    async function csRun(){
      const ccn = csNormalizeCcn(csEls.ccn.value);
      if(!ccn){
        csSetStatus("Enter a CCN first.");
        toast("Chain Snapshot", "Enter a CCN first.");
        return;
      }

      csSetStatus("Loading datasets...");
      csEls.facility.innerHTML = "<h4>Facility Summary</h4><p>Loading...</p>";
      csEls.chain.innerHTML = "<h4>Chain Summary</h4><p>Loading...</p>";
      csEls.rights.innerHTML = "<li>Loading...</li>";
      csEls.pbjResults.innerHTML = "<p>Loading...</p>";

      try{
        const providerUrl = await csFindDatasetUrl("Provider Information");
        const deficienciesUrl = await csFindDatasetUrl("Health Deficiencies");
        const chainUrl = await csFindDatasetUrl("Nursing Home Chain Performance Measures");
        const pbjUrl = await csFindDatasetUrl("Payroll Based Journal Daily Nurse Staffing");

        const providerQuery = csBuildSocrataUrl(providerUrl, {
          $limit: 5,
          $where: `provider_ccn='${ccn}' OR federal_provider_number='${ccn}' OR ccn='${ccn}'`,
        });
        const providerRows = await csFetchJson(providerQuery);
        const providerRow = providerRows?.[0] || null;
        csRenderFacilitySummary(providerRow);

        const chainId = csGetFirstValue(providerRow || {}, ["chain_id", "affiliated_entity_id", "ownership_id", "corporate_chain_id"]);
        if (chainId && chainUrl){
          const chainQuery = csBuildSocrataUrl(chainUrl, {
            $limit: 5,
            $where: `chain_id='${chainId}' OR affiliated_entity_id='${chainId}'`,
          });
          const chainRows = await csFetchJson(chainQuery);
          csRenderChainSummary(chainRows?.[0] || null);
        } else {
          csRenderChainSummary(null);
        }

        if (deficienciesUrl){
          const deficiencyQuery = csBuildSocrataUrl(deficienciesUrl, {
            $limit: 200,
            $where: `provider_ccn='${ccn}' OR federal_provider_number='${ccn}'`,
            $order: "survey_date DESC",
          });
          const deficiencyRows = await csFetchJson(deficiencyQuery);
          const rights = (deficiencyRows || []).filter((row)=>{
            const tag = (csGetFirstValue(row, ["f_tag", "tag_code", "deficiency_tag"]) || "").toUpperCase();
            return tag.startsWith("F");
          });
          csRenderRights(rights.slice(0, 25));
        } else {
          csRenderRights([]);
        }

        const start = csEls.pbjStart.value;
        const end = csEls.pbjEnd.value;

        if (pbjUrl && start && end){
          const pbjQuery = csBuildSocrataUrl(pbjUrl, {
            $limit: 50000,
            $where: `provider_ccn='${ccn}' AND work_date between '${start}' and '${end}'`,
          });
          const pbjRows = await csFetchJson(pbjQuery);

          const totals = (pbjRows || []).reduce((acc, row)=>{
            const census = Number(csGetFirstValue(row, ["census", "resident_count", "total_census"])) || 0;
            const rn = Number(csGetFirstValue(row, ["rn_hours", "registered_nurse_hours"])) || 0;
            const lpn = Number(csGetFirstValue(row, ["lpn_hours", "licensed_practical_nurse_hours"])) || 0;
            const cna = Number(csGetFirstValue(row, ["cna_hours", "certified_nurse_aide_hours"])) || 0;

            acc.totalCensus += census;
            acc.totalRn += rn;
            acc.totalLpn += lpn;
            acc.totalCna += cna;
            if (census > 0) acc.days += 1;
            return acc;
          }, { days: 0, totalCensus: 0, totalRn: 0, totalLpn: 0, totalCna: 0 });

          const totalHours = totals.totalRn + totals.totalLpn + totals.totalCna;
          const hprd = totals.totalCensus > 0 ? (totalHours / totals.totalCensus).toFixed(2) : "0.00";
          csRenderPbjResults({ ...totals, hprd });
        } else {
          csEls.pbjResults.innerHTML = "<p>Provide a date range to compute PBJ totals.</p>";
        }

        csSetStatus("Snapshot ready");
        toast("Chain Snapshot", "Snapshot ready.");
      } catch (err){
        console.error(err);
        csSetStatus("Error loading data");
        csEls.facility.innerHTML = "<h4>Facility Summary</h4><p>Unable to load data.</p>";
        csEls.chain.innerHTML = "<h4>Chain Summary</h4><p>Unable to load data.</p>";
        csEls.rights.innerHTML = "<li>Unable to load data.</li>";
        csEls.pbjResults.innerHTML = "<p>Unable to load data.</p>";
        toast("Chain Snapshot", "Error loading data.");
      }
    }
  </script>
</body>
</html>