<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DanBeem | Ombudsman Tools and Resource Lab</title>

  <style>
    :root{
      --bg:#070a16;
      --panel:rgba(255,255,255,0.07);
      --border:rgba(148,163,184,0.20);
      --text:#e5e7eb;
      --muted:rgba(229,231,235,0.70);
      --a:#38bdf8;
      --b:#a78bfa;
      --c:#22c55e;
      --shadow: 0 22px 80px rgba(0,0,0,0.55);
      --glass: rgba(6,8,26,0.55);
      --danger: #fb7185;
      --warn: #fbbf24;
      --ok: #22c55e;
      --ink: #07111f;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 18% 0%, rgba(56,189,248,0.26), transparent 60%),
        radial-gradient(800px 500px at 90% 10%, rgba(167,139,250,0.18), transparent 55%),
        radial-gradient(900px 600px at 50% 120%, rgba(34,197,94,0.12), transparent 60%),
        linear-gradient(180deg, #070a16, #050615);
      overflow-x:hidden;
    }

    /* Scroll progress bar */
    .progress {
      position: fixed;
      top: 0;
      left: 0;
      height: 4px;
      width: 0%;
      background: linear-gradient(90deg, var(--a), var(--b), var(--c));
      z-index: 1000;
      box-shadow: 0 10px 30px rgba(56,189,248,0.25);
    }

    /* Cursor spotlight */
    .spotlight {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1;
      background: radial-gradient(260px 260px at var(--x) var(--y), rgba(56,189,248,0.12), transparent 70%);
      mix-blend-mode: screen;
      opacity: 1;
      transition: opacity 220ms ease;
    }
    body.reduce-motion .spotlight { opacity: 0.2; }

    /* Top nav */
    .nav{
      position:sticky;
      top:0;
      z-index: 100;
      backdrop-filter: blur(12px);
      background: var(--glass);
      border-bottom: 1px solid rgba(148,163,184,0.14);
    }
    .navInner{
      width:min(1120px, 94vw);
      margin:0 auto;
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      position: relative;
      z-index: 2;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 950;
      letter-spacing:0.02em;
    }
    .logo{
      width:38px;height:38px;border-radius:14px;
      display:grid;place-items:center;
      background: rgba(56,189,248,0.16);
      border:1px solid rgba(56,189,248,0.26);
      box-shadow: 0 12px 36px rgba(56,189,248,0.12);
    }
    .navBtns{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .linkBtn{
      border:1px solid rgba(148,163,184,0.20);
      background: rgba(255,255,255,0.05);
      color:var(--text);
      border-radius: 999px;
      padding: 8px 11px;
      font-size: 12px;
      font-weight: 900;
      cursor:pointer;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
    }
    .linkBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(56,189,248,0.35);
      background: rgba(255,255,255,0.07);
    }
    .linkBtn.active{
      border-color: rgba(56,189,248,0.55);
      box-shadow: 0 10px 30px rgba(56,189,248,0.10);
    }

    .toggles{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .toggle{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(148,163,184,0.18);
      background: rgba(255,255,255,0.05);
      font-size: 12px;
      font-weight: 900;
      color: rgba(229,231,235,0.85);
      cursor:pointer;
      user-select:none;
    }
    .toggle .dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: rgba(229,231,235,0.35);
      border: 1px solid rgba(148,163,184,0.20);
    }
    .toggle.on .dot{ background: linear-gradient(135deg, var(--a), var(--b)); border-color: rgba(56,189,248,0.35); }

    .wrap{
      width:min(1120px, 94vw);
      margin:0 auto;
      padding: 18px 0 86px;
      position: relative;
      z-index: 2;
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 12px;border-radius:999px;
      font-size:12px;font-weight:950;
      color: rgba(56,189,248,0.95);
      background: rgba(56,189,248,0.10);
      border:1px solid rgba(56,189,248,0.22);
      margin-bottom:10px;
    }

    h1{
      margin:0 0 10px;
      font-size: clamp(44px, 6vw, 76px);
      line-height: 0.98;
      letter-spacing: -0.02em;
    }
    h2{ margin: 0 0 10px; font-size: 22px; }
    p{ margin:0 0 12px; color:var(--muted); line-height:1.65; }

    /* HERO */
    .hero{
      min-height: 86vh;
      display:grid;
      place-items:center;
      border-radius: 28px;
      border:1px solid rgba(148,163,184,0.16);
      background:
        radial-gradient(900px 600px at 18% 20%, rgba(56,189,248,0.18), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(167,139,250,0.14), transparent 60%),
        rgba(255,255,255,0.04);
      overflow:hidden;
      position:relative;
    }
    .heroInner{
      text-align:center;
      padding: 26px 18px;
      position:relative;
      z-index:2;
    }
    .heroSmall{
      font-size: 12px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color: rgba(229,231,235,0.72);
      margin-bottom: 10px;
    }
    #heroBig{ font-weight: 950; transform-origin:center; }
    #heroSub{ max-width: 860px; margin: 14px auto 0; font-size: 16px; }
    .typeLine{
      margin-top: 10px;
      font-size: 13px;
      color: rgba(229,231,235,0.62);
      font-weight: 800;
      min-height: 18px;
    }
    .glowOrb{
      position:absolute;
      width: 520px; height: 520px;
      border-radius: 999px;
      filter: blur(42px);
      opacity: 0.45;
      z-index:1;
      background: radial-gradient(circle, rgba(56,189,248,0.55), transparent 60%);
      left: -120px; top: -140px;
      transform: translate3d(0,0,0);
    }
    .glowOrb.two{
      background: radial-gradient(circle, rgba(167,139,250,0.55), transparent 60%);
      left: auto; right: -160px; top: 40px;
      width: 560px; height: 560px;
      opacity:0.35;
    }
    body.chaos .glowOrb { animation: floaty 5.5s ease-in-out infinite; }
    body.chaos .glowOrb.two { animation: floaty2 6.8s ease-in-out infinite; }
    @keyframes floaty{ 0%,100%{ transform: translate(0,0) } 50%{ transform: translate(20px, 18px) } }
    @keyframes floaty2{ 0%,100%{ transform: translate(0,0) } 50%{ transform: translate(-22px, 14px) } }

    /* Buttons */
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top: 12px; }
    button{
      border:0;
      cursor:pointer;
      border-radius: 14px;
      padding: 12px 16px;
      font-weight: 950;
      font-size: 14px;
      color:#07111f;
      background: linear-gradient(135deg, rgba(56,189,248,1), rgba(167,139,250,0.95));
      box-shadow: 0 18px 55px rgba(56,189,248,0.18);
      transition: transform 120ms ease, filter 120ms ease;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    button.secondary{
      color:var(--text);
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(148,163,184,0.22);
      box-shadow:none;
    }
    button.ghost{
      color: rgba(229,231,235,0.9);
      background: rgba(0,0,0,0.18);
      border:1px solid rgba(148,163,184,0.22);
      box-shadow:none;
    }

    /* Reveal animations */
    .reveal{
      opacity:0;
      transform: translateY(18px);
      transition: opacity 520ms ease, transform 520ms ease;
    }
    .reveal.show{
      opacity:1;
      transform: translateY(0);
    }
    body.reduce-motion .reveal{ opacity:1; transform:none; transition:none; }

    /* Cards for modules */
    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }
    .card{
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(148,163,184,0.16);
      border-radius: 20px;
      padding: 14px;
      box-shadow: 0 14px 45px rgba(0,0,0,0.28);
      transform-style: preserve-3d;
      transition: transform 160ms ease, border-color 160ms ease, background 160ms ease;
      position: relative;
      overflow:hidden;
      cursor: pointer;
    }
    .card:hover{
      border-color: rgba(56,189,248,0.30);
      background: rgba(255,255,255,0.06);
    }
    .card h3{ margin:0 0 6px; font-size: 16px; font-weight: 950; }
    .card p{ margin:0 0 10px; font-size: 13px; }

    /* Content box */
    .box{
      border-radius: 18px;
      padding: 14px;
      border:1px solid rgba(148,163,184,0.16);
      background: rgba(0,0,0,0.18);
      margin-top: 12px;
    }
    .hidden{ display:none; }

    img.inline{
      width:100%;
      border-radius: 18px;
      border:1px solid rgba(148,163,184,0.16);
      display:block;
      margin-top: 12px;
    }

    input, textarea, select{
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.22);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }
    textarea{ width:100%; min-height: 90px; resize: vertical; }

    .subtle{ font-size: 12px; color: rgba(229,231,235,0.55); }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(148,163,184,0.18);
      color: rgba(229,231,235,0.75);
      font-size: 12px;
      font-weight: 900;
      background: rgba(0,0,0,0.25);
      user-select:none;
    }

    /* Toast */
    .toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 1001;
      display:flex;
      flex-direction: column;
      gap: 10px;
      width: min(360px, 92vw);
    }
    .toastItem{
      border-radius: 16px;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(148,163,184,0.18);
      padding: 12px 12px;
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 60px rgba(0,0,0,0.45);
      animation: toastIn 220ms ease;
    }
    @keyframes toastIn{
      from{ transform: translateY(10px); opacity: 0; }
      to{ transform: translateY(0); opacity: 1; }
    }
    .toastTitle{ font-weight: 950; margin:0 0 4px; font-size: 13px; }
    .toastMsg{ margin:0; font-size: 12px; color: rgba(229,231,235,0.75); line-height: 1.45; }

    /* Confetti */
    .confetti{
      position: fixed;
      inset: 0;
      pointer-events:none;
      z-index: 1002;
      overflow:hidden;
    }
    .confettiPiece{
      position:absolute;
      width: 10px;
      height: 14px;
      border-radius: 3px;
      opacity: 0.95;
      transform: translateY(-20px);
      animation: fall 900ms linear forwards;
    }
    @keyframes fall{
      to{
        transform: translateY(110vh) rotate(720deg);
        opacity: 0.9;
      }
    }

    /* Tabs */
    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .tabBtn{
      border:1px solid rgba(148,163,184,0.18);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      cursor:pointer;
    }
    .tabBtn.active{
      background: linear-gradient(135deg, rgba(56,189,248,1), rgba(167,139,250,0.95));
      color:#07111f;
      border-color: transparent;
    }

    /* Dashboard specific */
    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    .kpi{
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.16);
      background: rgba(0,0,0,0.18);
      padding: 12px;
      position: relative;
      overflow:hidden;
    }
    .kpiTitle{
      font-weight: 950;
      font-size: 12px;
      color: rgba(229,231,235,0.68);
      margin-bottom: 6px;
    }
    .kpiValue{
      font-weight: 950;
      font-size: 28px;
      letter-spacing: -0.01em;
    }
    .kpiDelta{
      margin-top: 6px;
      font-size: 12px;
      font-weight: 900;
      color: rgba(229,231,235,0.7);
    }
    .kpiDelta.up{ color: rgba(34,197,94,0.95); }
    .kpiDelta.down{ color: rgba(251,113,133,0.95); }

    .dashRow{
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 12px;
      margin-top: 12px;
      align-items: start;
    }
    @media (max-width: 900px){
      .dashRow{ grid-template-columns: 1fr; }
    }
    .chartBox{
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.16);
      background: rgba(0,0,0,0.18);
      padding: 12px;
    }
    .chartHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap:wrap;
    }
    .chartTitle{
      font-weight: 950;
      font-size: 14px;
    }
    .chartSub{
      font-size: 12px;
      color: rgba(229,231,235,0.62);
      margin-top: 2px;
    }
    canvas{
      width: 100%;
      height: 280px;
      display:block;
      border-radius: 12px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(148,163,184,0.10);
    }

    .callout{
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.16);
      background: rgba(0,0,0,0.18);
      padding: 12px;
    }
    .callout h4{
      margin: 0 0 8px;
      font-size: 14px;
    }
    .callout p, .callout li{ color: var(--muted); font-size: 13px; line-height: 1.55; }
    .callout ul{ margin: 0; padding-left: 18px; }

    body.reduce-motion *{
      animation-duration: 1ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 1ms !important;
      scroll-behavior: auto !important;
    }
  </style>
</head>

<body>
  <div class="progress" id="progress"></div>
  <div class="spotlight" id="spotlight"></div>
  <div class="confetti" id="confetti"></div>
  <div class="toast" id="toast"></div>

  <div class="nav">
    <div class="navInner">
      <div class="brand">
        <div class="logo">‚ö°</div>
        <div>DanBeem</div>
      </div>

      <div class="navBtns">
        <button class="linkBtn" data-target="top" onclick="scrollToId('top')">Top</button>
        <button class="linkBtn" data-target="dashboard" onclick="scrollToId('dashboard')">Dashboard</button>
        <button class="linkBtn" data-target="apps" onclick="scrollToId('apps')">Tools</button>
        <button class="linkBtn" data-target="carousel" onclick="scrollToId('carousel')">Lab</button>
      </div>

      <div class="toggles">
        <div class="toggle" id="motionToggle" onclick="toggleMotion()"><span class="dot"></span>Reduce motion</div>
        <div class="toggle" id="chaosToggle" onclick="toggleChaos()"><span class="dot"></span>Chaos</div>
      </div>
    </div>
  </div>

  <div class="wrap" id="top">
    <section class="hero">
      <div class="glowOrb" id="orb1"></div>
      <div class="glowOrb two" id="orb2"></div>

      <div class="heroInner">
        <div class="heroSmall">GitHub Pages test environment</div>
        <h1 id="heroBig">Ombudsman Tools and Resource Lab</h1>
        <p id="heroSub">
          A single file site for demos, interactive dashboards, and small tools.
          Some modules are serious, some are just for fun.
        </p>
        <div class="typeLine" id="typeLine"></div>
        <div class="btnRow">
          <button onclick="scrollToId('dashboard')">View report dashboard</button>
          <button class="secondary" onclick="scrollToId('apps')">Open tools</button>
        </div>
        <p class="subtle" style="max-width:860px;margin:12px auto 0;">
          Note: This is a prototype space. Data shown can be illustrative unless you wire it to a live source.
        </p>
      </div>
    </section>

    <!-- DASHBOARD SECTION -->
    <section id="dashboard" class="panel reveal" style="margin-top:18px;">
      <div class="pill">Report dashboard</div>
      <h2>Connecticut LTCOP 2024 Annual Report, two year comparison</h2>
      <p>
        Interactive summary cards, quick charts, and a one click PPTX export for sharing.
        Use this as a living draft, then swap in your final numbers when ready.
      </p>

      <div class="box">
        <div class="btnRow" style="justify-content:flex-start;">
          <span class="badge" id="repStatus">Ready</span>

          <label class="subtle" style="margin-left:6px;">Metric set</label>
          <select id="repPreset" onchange="repApplyPreset()">
            <option value="annual">Annual Report, FFY 2023 vs FFY 2024</option>
            <option value="annual_alt">Annual Report, alternate example set</option>
          </select>

          <label class="subtle" style="margin-left:6px;">Focus</label>
          <select id="repFocus" onchange="repRenderAll()">
            <option value="all">All</option>
            <option value="cases">Cases</option>
            <option value="complaints">Complaints</option>
            <option value="reach">Reach</option>
            <option value="resources">Resources</option>
          </select>

          <button class="secondary" onclick="repConfetti()">Celebrate</button>
          <button onclick="repDownloadPptx()">Download PPTX slides</button>
        </div>

        <div class="kpiGrid" id="kpiGrid"></div>

        <div class="dashRow">
          <div class="chartBox tilt">
            <div class="chartHeader">
              <div>
                <div class="chartTitle" id="chartTitle1">Cases</div>
                <div class="chartSub" id="chartSub1">FFY 2023 vs FFY 2024</div>
              </div>
              <div class="btnRow" style="justify-content:flex-end;margin-top:0;">
                <button class="ghost" onclick="repSetChart('cases')">Cases</button>
                <button class="ghost" onclick="repSetChart('rcc_nf')">RCC vs NF</button>
                <button class="ghost" onclick="repSetChart('complaints')">Complaints</button>
              </div>
            </div>
            <canvas id="chart1" width="900" height="320" aria-label="Bar chart"></canvas>
            <p class="subtle" id="chartNote1" style="margin-top:8px;"></p>
          </div>

          <div class="callout tilt">
            <h4>Headline insights</h4>
            <ul id="insightList">
              <li>Use the focus selector to emphasize a story for a specific audience.</li>
              <li>Use the PPTX export for quick internal briefings.</li>
              <li>Swap in final numbers as your report stabilizes.</li>
            </ul>

            <div class="box" style="margin-top:12px;">
              <div style="font-weight:950;font-size:12px;color:rgba(229,231,235,0.68);">One sentence summary</div>
              <textarea id="repSummary" style="margin-top:8px;min-height:90px;"
                placeholder="Example: Cases increased while residential care complaints surged, with strong resolution rates maintained."></textarea>
              <div class="btnRow" style="justify-content:flex-start;">
                <button class="secondary" onclick="repAutoSummary()">Auto draft</button>
                <button class="secondary" onclick="repCopySummary()">Copy</button>
              </div>
              <p class="subtle" style="margin-top:8px;">
                PPTX slide 2 will use this summary text.
              </p>
            </div>

            <div class="box" style="margin-top:12px;">
              <div style="font-weight:950;font-size:12px;color:rgba(229,231,235,0.68);">Data disclaimer</div>
              <p class="subtle" style="margin-top:8px;">
                This prototype is for presentation and workflow testing. Replace placeholder values with official annual report figures before publication.
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TOOLS SECTION -->
    <section id="apps" class="panel reveal" style="margin-top:18px;">
      <div class="pill">Tools and prototypes</div>
      <h2>Modules</h2>
      <p>Pick a module. The dashboard above is the report view. These are additional tools and demos.</p>

      <div class="grid">
        <div class="card tilt" onclick="showApp('report')">
          <h3>üìä Report Dashboard</h3>
          <p>Quick view of the two year comparison and PPTX export.</p>
          <button onclick="event.stopPropagation(); scrollToId('dashboard')">Open</button>
        </div>

        <div class="card tilt" onclick="showApp('chain')">
          <h3>üß© Chain Snapshot</h3>
          <p>CCN lookup: facility summary, chain staffing, resident rights tags, PBJ HPRD math.</p>
          <button onclick="event.stopPropagation(); showApp('chain')">Open</button>
        </div>

        <div class="card tilt" onclick="showApp('prompt')">
          <h3>üß† Prompt Builder</h3>
          <p>Generate a research prompt you paste into ChatGPT.</p>
          <button onclick="event.stopPropagation(); showApp('prompt')">Open</button>
        </div>

        <div class="card tilt" onclick="showApp('timer')">
          <h3>‚è≤Ô∏è Timer</h3>
          <p>Presets, custom time, beep, and title countdown.</p>
          <button onclick="event.stopPropagation(); showApp('timer')">Open</button>
        </div>

        <div class="card tilt" onclick="showApp('dad')">
          <h3>üòÑ Dad Joke Generator</h3>
          <p>One click jokes. Copy button. Toast feedback.</p>
          <button onclick="event.stopPropagation(); showApp('dad')">Open</button>
        </div>

        <div class="card tilt" onclick="showApp('sourdough')">
          <h3>ü•ñ Sourdough Compliance</h3>
          <p>Users can choose Yes or choose Yes. Includes confetti.</p>
          <button onclick="event.stopPropagation(); showApp('sourdough')">Open</button>
        </div>
      </div>

      <div id="appHome" class="box">
        Pick a module above.
      </div>

      <div id="appSourdough" class="box hidden">
        <h2>Important Question</h2>
        <p>Are you interested in learning about Dan‚Äôs love of sourdough bread?</p>

        <div id="sd1" class="btnRow">
          <button onclick="sdYes()">Yes</button>
          <button class="secondary" onclick="sdNo()">No</button>
        </div>

        <div id="sd2" class="hidden">
          <p>Let‚Äôs revisit this. Starter care, hydration ratios, cold retard timing, unsolicited bread facts.</p>
          <div class="btnRow"><button onclick="sdYes()">Yes</button></div>
        </div>

        <div id="sd3" class="hidden">
          <h2>Welcome to the Crumb Zone</h2>
          <p>Sourdough is a responsibility.</p>
          <img class="inline" src="sourdough_hero_loaf.jpg" alt="Hero loaf">
          <div class="btnRow">
            <button class="secondary" onclick="resetSourdough()">Restart</button>
            <button onclick="toast('Bread', 'Thank you for accepting your fate.')">Toast</button>
          </div>
        </div>
      </div>

      <div id="appDad" class="box hidden">
        <h2>Dad Joke Generator</h2>
        <p>Press generate. Copy. Become a menace.</p>
        <div class="btnRow">
          <button onclick="newJoke()">Generate</button>
          <button class="secondary" onclick="copyJoke()">Copy</button>
        </div>
        <div class="box" style="margin-top:10px;">
          <div style="font-weight:950; font-size:12px; color:rgba(229,231,235,0.65);">Joke</div>
          <div id="jokeText" style="font-size:18px;font-weight:950;margin-top:6px;">Click Generate.</div>
        </div>
      </div>

      <div id="appTimer" class="box hidden">
        <h2>Timer</h2>
        <p>Presets or custom. Beep when done. Title updates.</p>

        <div class="btnRow" style="justify-content:flex-start;">
          <label style="color:var(--muted); font-size:12px;">Preset</label>
          <select id="preset" onchange="applyPreset()">
            <option value="">Choose one</option>
            <option value="20:00">Preheat (20:00)</option>
            <option value="45:00">Bake covered (45:00)</option>
            <option value="15:00">Bake uncovered (15:00)</option>
            <option value="30:00">Proof check (30:00)</option>
          </select>
        </div>

        <div class="btnRow" style="justify-content:flex-start;">
          <label style="color:var(--muted); font-size:12px;">Set time</label>
          <input id="mins" type="number" min="0" placeholder="min" style="width:100px;">
          <input id="secs" type="number" min="0" max="59" placeholder="sec" style="width:100px;">
          <button class="secondary" onclick="setFromInputs()">Set</button>
        </div>

        <div style="font-size:54px;font-weight:950;letter-spacing:0.02em;margin:10px 0 6px;text-align:center;" id="timerDisplay">00:00</div>
        <div class="subtle" id="timerStatus" style="text-align:center;">Not running</div>

        <div class="btnRow">
          <button onclick="startTimer()">Start</button>
          <button class="secondary" onclick="pauseTimer()">Pause</button>
          <button class="secondary" onclick="resetTimer()">Reset</button>
        </div>
      </div>

      <div id="appPrompt" class="box hidden">
        <h2>Prompt Builder</h2>
        <p>Fill a few fields. Copy a structured prompt. Paste into ChatGPT.</p>

        <div class="box">
          <div style="display:grid; gap:10px;">
            <input id="pbTopic" placeholder="Topic (example: CMS nursing home quality measures)" />
            <input id="pbGoal" placeholder="Goal (example: summarize key risks and action items)" />
            <input id="pbConstraints" placeholder="Constraints (example: cite sources, keep it plain language)" />
            <textarea id="pbContext" placeholder="Optional context you already know or want included"></textarea>
            <div class="btnRow" style="justify-content:flex-start;">
              <button onclick="buildPrompt()">Build</button>
              <button class="secondary" onclick="copyBuiltPrompt()">Copy</button>
              <button class="secondary" onclick="toast('Prompt Builder', 'Pro tip: keep prompts short and repeatable.')">Tip</button>
            </div>
          </div>
        </div>

        <div class="box" style="margin-top:12px;">
          <div style="font-weight:950; font-size:12px; color:rgba(229,231,235,0.65);">Generated prompt</div>
          <textarea id="pbOutput" readonly style="margin-top:8px; min-height:140px;"></textarea>
        </div>
      </div>

      <!-- Chain Snapshot -->
      <div id="appChain" class="box hidden">
        <h2>Chain Snapshot</h2>
        <p>Enter a CCN, run it, then switch tabs. Defaults to PBJ Advanced.</p>

        <div class="btnRow" style="justify-content:flex-start;">
          <label style="color:var(--muted); font-size:12px;">CCN</label>
          <input id="csCcn" type="text" placeholder="e.g. 123456" style="width:160px;">
          <span class="badge" id="csStatus">Awaiting query</span>
          <button onclick="csRun()">Run</button>
          <button class="secondary" onclick="csClear()">Clear</button>
        </div>

        <div class="tabs" role="tablist" aria-label="Chain Snapshot tabs">
          <button class="tabBtn" id="csTabSummary" onclick="csSetTab('summary')">Summary</button>
          <button class="tabBtn" id="csTabRights" onclick="csSetTab('rights')">Resident Rights F Tags</button>
          <button class="tabBtn" id="csTabPbj" onclick="csSetTab('pbj')">PBJ Advanced</button>
        </div>

        <div id="csPanelSummary">
          <div class="box" id="csFacility" style="margin-top:10px;">
            <h4 style="margin:0 0 8px;">Facility Summary</h4>
            <p>Run a CCN to populate details.</p>
          </div>
          <div class="box" id="csChain" style="margin-top:10px;">
            <h4 style="margin:0 0 8px;">Chain Summary</h4>
            <p>Chain details will appear here when available.</p>
          </div>
        </div>

        <div id="csPanelRights" class="hidden">
          <div class="box" style="margin-top:10px;">
            <h4 style="margin:0 0 8px;">Resident Rights F Tags (newest 25)</h4>
            <ul id="csRightsList">
              <li>Run a CCN to populate results.</li>
            </ul>
          </div>
        </div>

        <div id="csPanelPbj" class="hidden">
          <div class="box" style="margin-top:10px;">
            <h4 style="margin:0 0 8px;">PBJ Daily Nurse Staffing</h4>
            <div class="btnRow" style="justify-content:flex-start;">
              <label style="color:var(--muted); font-size:12px;">Start</label>
              <input id="csPbjStart" type="date">
              <label style="color:var(--muted); font-size:12px;">End</label>
              <input id="csPbjEnd" type="date">
              <button class="secondary" onclick="csRun()">Run</button>
            </div>
            <div id="csPbjResults">
              <p>Choose a date range and run to see PBJ totals.</p>
            </div>
          </div>

          <div class="box" style="margin-top:10px;">
            <h4 style="margin:0 0 8px;">Notes</h4>
            <p>This uses the CMS data.cms.gov catalog and tries to locate datasets by title. If CMS changes dataset titles or disables CORS, this may fail gracefully.</p>
          </div>
        </div>
      </div>

      <div class="btnRow" style="margin-top:14px;">
        <button class="secondary" onclick="showApp('apps')">Close modules</button>
      </div>
    </section>

    <!-- LAB SECTION (kept for your existing bread carousel assets) -->
    <section id="carousel" class="panel reveal" style="margin-top:18px;">
      <div class="pill">Lab gallery</div>
      <h2>Carousel demo</h2>
      <p>Upload bread1.jpg to bread6.jpg in the repo if you want to keep this section.</p>

      <div class="box">
        <div class="subtle">If you do not want the bread assets, remove this whole section.</div>
      </div>

      <div class="box" style="margin-top:12px; padding:0; overflow:hidden;">
        <div style="display:flex; gap:14px; overflow-x:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; padding: 12px;">
          <div style="flex:0 0 86%; max-width:86%; height:280px; border-radius:18px; overflow:hidden; scroll-snap-align:center; border:1px solid rgba(148,163,184,0.16); background: rgba(0,0,0,0.18);">
            <img src="bread1.jpg" alt="Bread 1" style="width:100%;height:100%;object-fit:cover;display:block;">
          </div>
          <div style="flex:0 0 86%; max-width:86%; height:280px; border-radius:18px; overflow:hidden; scroll-snap-align:center; border:1px solid rgba(148,163,184,0.16); background: rgba(0,0,0,0.18);">
            <img src="bread2.jpg" alt="Bread 2" style="width:100%;height:100%;object-fit:cover;display:block;">
          </div>
          <div style="flex:0 0 86%; max-width:86%; height:280px; border-radius:18px; overflow:hidden; scroll-snap-align:center; border:1px solid rgba(148,163,184,0.16); background: rgba(0,0,0,0.18);">
            <img src="bread3.jpg" alt="Bread 3" style="width:100%;height:100%;object-fit:cover;display:block;">
          </div>
        </div>
      </div>

      <div class="subtle" style="margin-top:12px;">
        Single file, deploy friendly, and still fun.
      </div>
    </section>

    <div class="subtle" style="margin-top:16px;">
      Prototype environment. If you want a public facing version, I can help you create a second page that is report only.
    </div>
  </div>

  <!-- PptxGenJS for PPTX export -->
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

  <script>
    /* =========================
       Global UI utilities
       ========================= */

    // Progress bar
    const progress = document.getElementById("progress");
    function updateProgress(){
      const h = document.documentElement;
      const sc = h.scrollTop || document.body.scrollTop;
      const max = (h.scrollHeight - h.clientHeight) || 1;
      const pct = (sc / max) * 100;
      progress.style.width = pct + "%";
    }
    window.addEventListener("scroll", updateProgress, {passive:true});
    window.addEventListener("resize", updateProgress);
    updateProgress();

    // Spotlight follows pointer
    function setSpot(x, y){
      document.documentElement.style.setProperty("--x", x + "px");
      document.documentElement.style.setProperty("--y", y + "px");
    }
    window.addEventListener("pointermove", (e)=> setSpot(e.clientX, e.clientY), {passive:true});
    setSpot(window.innerWidth/2, window.innerHeight/3);

    function scrollToId(id){
      const el = document.getElementById(id);
      if(!el) return;
      el.scrollIntoView({behavior:"smooth", block:"start"});
    }

    // Nav active based on scroll position
    const navButtons = Array.from(document.querySelectorAll(".linkBtn"));
    const targets = navButtons.map(b => document.getElementById(b.dataset.target)).filter(Boolean);
    const navIO = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{
        if(e.isIntersecting){
          navButtons.forEach(b => b.classList.toggle("active", b.dataset.target === e.target.id));
        }
      });
    }, { threshold: 0.35 });
    targets.forEach(t => navIO.observe(t));

    // Helpers
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

    // Hero scroll effect plus orbs
    const heroBig = document.getElementById("heroBig");
    const heroSub = document.getElementById("heroSub");
    const orb1 = document.getElementById("orb1");
    const orb2 = document.getElementById("orb2");
    function heroScroll(){
      const sc = window.scrollY || 0;
      const p = clamp(sc / window.innerHeight, 0, 1.1);
      const scale = 1 + p * 0.18;
      const blur = p * 4;
      const op = 1 - p * 0.25;

      heroBig.style.transform = `scale(${scale})`;
      heroBig.style.filter = `blur(${blur}px)`;
      heroBig.style.opacity = `${op}`;

      heroSub.style.transform = `translateY(${p*10}px)`;
      heroSub.style.opacity = `${1 - p*0.55}`;

      if(!document.body.classList.contains("chaos")){
        orb1.style.transform = `translate(${sc*0.05}px, ${sc*0.03}px)`;
        orb2.style.transform = `translate(${sc*-0.03}px, ${sc*0.04}px)`;
      }
    }
    window.addEventListener("scroll", heroScroll, {passive:true});
    window.addEventListener("resize", heroScroll);
    heroScroll();

    // Typewriter line
    const typeLine = document.getElementById("typeLine");
    const typeText = "Dashboard demos, ombudsman tooling, and small prototype apps, all in one file.";
    let ti = 0;
    function typeTick(){
      if(document.body.classList.contains("reduce-motion")){ typeLine.textContent = typeText; return; }
      typeLine.textContent = typeText.slice(0, ti);
      ti += 1;
      if(ti <= typeText.length) setTimeout(typeTick, 16);
    }
    typeTick();

    // Reveal on scroll
    const reveals = document.querySelectorAll(".reveal");
    const io = new IntersectionObserver((entries)=>{
      for(const e of entries){
        if(e.isIntersecting) e.target.classList.add("show");
      }
    }, { threshold: 0.14 });
    reveals.forEach(r => io.observe(r));

    // Tilt effect
    function attachTilt(el){
      if(!el) return;
      el.addEventListener("pointermove", (e)=>{
        if(document.body.classList.contains("reduce-motion")) return;
        const r = el.getBoundingClientRect();
        const px = (e.clientX - r.left) / r.width;
        const py = (e.clientY - r.top) / r.height;
        const rx = (py - 0.5) * -8;
        const ry = (px - 0.5) * 8;
        el.style.transform = `perspective(900px) rotateX(${rx}deg) rotateY(${ry}deg) translateY(-2px)`;
      });
      el.addEventListener("pointerleave", ()=>{ el.style.transform = ""; });
    }
    document.querySelectorAll(".tilt").forEach(attachTilt);

    // Motion and chaos toggles
    const motionToggle = document.getElementById("motionToggle");
    const chaosToggle = document.getElementById("chaosToggle");
    function toggleMotion(){
      document.body.classList.toggle("reduce-motion");
      motionToggle.classList.toggle("on");
      toast("Motion", document.body.classList.contains("reduce-motion") ? "Reduced motion enabled." : "Reduced motion disabled.");
      repRenderAll();
    }
    function toggleChaos(){
      document.body.classList.toggle("chaos");
      chaosToggle.classList.toggle("on");
      toast("Chaos", document.body.classList.contains("chaos") ? "Chaos enabled." : "Chaos disabled.");
    }

    // Toast system
    const toastWrap = document.getElementById("toast");
    function escapeHtml(s){
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }
    function toast(title, msg){
      const t = document.createElement("div");
      t.className = "toastItem";
      t.innerHTML = `<div class="toastTitle">${escapeHtml(title)}</div><p class="toastMsg">${escapeHtml(msg)}</p>`;
      toastWrap.appendChild(t);
      setTimeout(()=>{ t.style.opacity = "0"; t.style.transform = "translateY(6px)"; }, 2200);
      setTimeout(()=>{ t.remove(); }, 2600);
    }

    // Confetti burst
    const confetti = document.getElementById("confetti");
    function confettiBurst(){
      if(document.body.classList.contains("reduce-motion")) return;
      const colors = ["#38bdf8","#a78bfa","#22c55e","#fbbf24","#fb7185"];
      for(let i=0;i<34;i++){
        const p = document.createElement("div");
        p.className = "confettiPiece";
        p.style.left = Math.random()*100 + "vw";
        p.style.background = colors[Math.floor(Math.random()*colors.length)];
        p.style.animationDuration = (700 + Math.random()*700) + "ms";
        p.style.width = (8 + Math.random()*10) + "px";
        p.style.height = (10 + Math.random()*12) + "px";
        confetti.appendChild(p);
        setTimeout(()=> p.remove(), 1400);
      }
    }

    /* =========================
       Mini apps show and hide
       ========================= */

    const appHome = document.getElementById("appHome");
    const appSourdough = document.getElementById("appSourdough");
    const appDad = document.getElementById("appDad");
    const appTimer = document.getElementById("appTimer");
    const appPrompt = document.getElementById("appPrompt");
    const appChain = document.getElementById("appChain");

    function showApp(which){
      appHome.classList.add("hidden");
      appSourdough.classList.add("hidden");
      appDad.classList.add("hidden");
      appTimer.classList.add("hidden");
      appPrompt.classList.add("hidden");
      appChain.classList.add("hidden");

      if(which === "apps"){
        appHome.classList.remove("hidden");
        resetSourdough();
        stopIntervalOnly();
        toast("Modules", "Closed. Choose another module.");
      }
      if(which === "report"){
        scrollToId("dashboard");
        toast("Dashboard", "Opened report dashboard.");
      }
      if(which === "sourdough"){
        appSourdough.classList.remove("hidden");
        stopIntervalOnly();
        resetSourdough();
        toast("Sourdough", "Compliance required.");
      }
      if(which === "dad"){
        appDad.classList.remove("hidden");
        stopIntervalOnly();
        toast("Dad Jokes", "Your fate is sealed.");
      }
      if(which === "timer"){
        appTimer.classList.remove("hidden");
        toast("Timer", "Set your schedule.");
      }
      if(which === "prompt"){
        appPrompt.classList.remove("hidden");
        stopIntervalOnly();
        toast("Prompt Builder", "Build a reusable research prompt.");
      }
      if(which === "chain"){
        appChain.classList.remove("hidden");
        stopIntervalOnly();
        csSetTab("pbj");
        toast("Chain Snapshot", "Defaults to PBJ Advanced.");
      }
      scrollToId("apps");
    }

    /* =========================
       Sourdough app
       ========================= */
    function sdNo(){
      document.getElementById("sd1").classList.add("hidden");
      document.getElementById("sd2").classList.remove("hidden");
      toast("Question", "Incorrect choice detected.");
    }
    function sdYes(){
      document.getElementById("sd1").classList.add("hidden");
      document.getElementById("sd2").classList.add("hidden");
      document.getElementById("sd3").classList.remove("hidden");
      toast("Bread accepted", "Welcome to the Crumb Zone.");
      confettiBurst();
    }
    function resetSourdough(){
      const a = document.getElementById("sd1");
      const b = document.getElementById("sd2");
      const c = document.getElementById("sd3");
      if(!a || !b || !c) return;
      a.classList.remove("hidden");
      b.classList.add("hidden");
      c.classList.add("hidden");
    }

    /* =========================
       Dad jokes
       ========================= */
    const dadJokes = [
      "I used to hate facial hair, but then it grew on me.",
      "I‚Äôm reading a book about anti gravity. It‚Äôs impossible to put down.",
      "I don‚Äôt trust stairs. They‚Äôre always up to something.",
      "What do you call fake spaghetti? An impasta.",
      "I only know 25 letters of the alphabet. I don‚Äôt know y.",
      "How do you organize a space party? You planet.",
      "Why don‚Äôt eggs tell jokes? They‚Äôd crack each other up.",
      "I used to play piano by ear. Now I use my hands.",
      "I told my wife she should embrace her mistakes. She hugged me.",
      "I ordered a chicken and an egg online. I‚Äôll let you know."
    ];
    function newJoke(){
      const i = Math.floor(Math.random()*dadJokes.length);
      document.getElementById("jokeText").textContent = dadJokes[i];
      toast("Dad Joke", "Generated.");
    }
    async function copyJoke(){
      const t = document.getElementById("jokeText").textContent || "";
      if(!t.trim()) return;
      try{
        await navigator.clipboard.writeText(t);
        toast("Copied", "Joke copied to clipboard.");
      }catch{
        alert("Copy failed on this device. Press and hold to copy manually.");
      }
    }

    /* =========================
       Timer
       ========================= */
    let timerTotalSeconds = 0;
    let timerRemainingSeconds = 0;
    let timerInterval = null;

    function formatTime(s){
      const mm = String(Math.floor(s/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      return `${mm}:${ss}`;
    }
    function setDisplay(){
      document.getElementById("timerDisplay").textContent = formatTime(timerRemainingSeconds);
      document.title = timerInterval ? `‚è≤Ô∏è ${formatTime(timerRemainingSeconds)} DanBeem` : "DanBeem | Ombudsman Tools and Resource Lab";
    }
    function setTimerStatus(t){
      document.getElementById("timerStatus").textContent = t;
    }
    function applyPreset(){
      const val = document.getElementById("preset").value;
      if(!val) return;
      const parts = val.split(":");
      const m = Number(parts[0] || 0);
      const s = Number(parts[1] || 0);
      timerTotalSeconds = (m*60) + s;
      timerRemainingSeconds = timerTotalSeconds;
      setDisplay();
      setTimerStatus("Ready");
      toast("Timer", "Preset loaded.");
    }
    function setFromInputs(){
      const mm = Number(document.getElementById("mins").value||0);
      const ss = clamp(Number(document.getElementById("secs").value||0), 0, 59);
      timerTotalSeconds = (Math.max(mm,0)*60) + ss;
      timerRemainingSeconds = timerTotalSeconds;
      setDisplay();
      setTimerStatus("Ready");
      toast("Timer", "Custom time set.");
    }
    function startTimer(){
      if(timerRemainingSeconds <= 0){ setTimerStatus("Set a time first"); toast("Timer", "Set a time first."); return; }
      if(timerInterval) return;
      setTimerStatus("Running");
      toast("Timer", "Started.");
      timerInterval = setInterval(()=>{
        timerRemainingSeconds -= 1;
        if(timerRemainingSeconds <= 0){
          timerRemainingSeconds = 0;
          setDisplay();
          stopIntervalOnly();
          setTimerStatus("Done");
          beep();
          confettiBurst();
          toast("Timer done", "Time.");
          alert("Timer done!");
          return;
        }
        setDisplay();
      }, 1000);
    }
    function pauseTimer(){
      if(!timerInterval) return;
      stopIntervalOnly();
      setTimerStatus("Paused");
      toast("Timer", "Paused.");
    }
    function resetTimer(){
      stopIntervalOnly();
      timerRemainingSeconds = timerTotalSeconds;
      setDisplay();
      setTimerStatus("Ready");
      toast("Timer", "Reset.");
    }
    function stopIntervalOnly(){
      if(timerInterval){
        clearInterval(timerInterval);
        timerInterval = null;
        document.title = "DanBeem | Ombudsman Tools and Resource Lab";
      }
    }
    function beep(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.value = 880;
        gain.gain.value = 0.05;
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        setTimeout(()=>{ osc.stop(); ctx.close(); }, 220);
      }catch{}
    }
    setDisplay();

    /* =========================
       Prompt builder
       ========================= */
    function buildPrompt(){
      const topic = (document.getElementById("pbTopic").value || "").trim();
      const goal = (document.getElementById("pbGoal").value || "").trim();
      const constraints = (document.getElementById("pbConstraints").value || "").trim();
      const context = (document.getElementById("pbContext").value || "").trim();

      const prompt =
`You are my research assistant. I am building a quick, accurate brief.

Topic:
${topic || "Unspecified topic"}

Goal:
${goal || "Provide a structured summary and next steps."}

Constraints:
${constraints || "Use clear plain language. Provide citations where possible. Be practical and specific."}

Context I already have:
${context || "None provided."}

Output format:
1) Key facts (bullets)
2) What matters and why (short paragraphs)
3) Risks and unknowns
4) Recommended next steps
5) Questions I should answer next`;

      document.getElementById("pbOutput").value = prompt;
      toast("Prompt Builder", "Prompt generated.");
    }

    async function copyBuiltPrompt(){
      const t = document.getElementById("pbOutput").value || "";
      if(!t.trim()){ toast("Prompt Builder", "Nothing to copy yet."); return; }
      try{
        await navigator.clipboard.writeText(t);
        toast("Copied", "Prompt copied to clipboard.");
      }catch{
        alert("Copy failed on this device. Press and hold to copy manually.");
      }
    }

    /* =========================
       Report Dashboard
       ========================= */

    const rep = {
      statusEl: document.getElementById("repStatus"),
      presetEl: document.getElementById("repPreset"),
      focusEl: document.getElementById("repFocus"),
      kpiGrid: document.getElementById("kpiGrid"),
      chart1: document.getElementById("chart1"),
      chartTitle1: document.getElementById("chartTitle1"),
      chartSub1: document.getElementById("chartSub1"),
      chartNote1: document.getElementById("chartNote1"),
      insightList: document.getElementById("insightList"),
      summaryEl: document.getElementById("repSummary")
    };

    const repPresets = {
      annual: {
        title: "Connecticut LTCOP Impact Report",
        subtitle: "FFY 2023 vs FFY 2024",
        data: {
          years: ["FFY 2023", "FFY 2024"],
          cases: [2333, 2628],
          nf_cases: [2197, 2197],
          rcc_cases: [163, 428],
          complaints_total: [0, 4415], /* placeholder if you want */
          resolved_pct: [0.0, 0.83],
          facilities: [410, 410],
          nf_facilities: [195, 195],
          rcc_facilities: [215, 215],
          beds: [36152, 36152],
          fte: [13.0, 15.0],
          volunteers: [0, 18],
          volunteer_hours: [0, 764],
          visits: [1878, 1910],
          facilities_visited: [375, 400],
          routine_access: [93, 158],
          community_events: [13, 47],
          discharge_complaints: [533, 666],
          quality_of_care: [0, 1264],
          autonomy_rights: [0, 559],
          facility_policies: [0, 345]
        },
        notes: {
          cases: "Cases increased 12.6%.",
          rcc_nf: "RCC complaints surged while nursing facility volume stayed relatively stable.",
          complaints: "Top categories shown from your draft slide text."
        }
      },
      annual_alt: {
        title: "Connecticut LTCOP Impact Report",
        subtitle: "FFY 2023 vs FFY 2024",
        data: {
          years: ["FFY 2023", "FFY 2024"],
          cases: [2400, 2700],
          nf_cases: [2250, 2240],
          rcc_cases: [150, 460],
          complaints_total: [4000, 4600],
          resolved_pct: [0.81, 0.83],
          facilities: [410, 410],
          nf_facilities: [195, 195],
          rcc_facilities: [215, 215],
          beds: [36152, 36152],
          fte: [14.0, 15.0],
          volunteers: [14, 18],
          volunteer_hours: [620, 764],
          visits: [1860, 1910],
          facilities_visited: [372, 400],
          routine_access: [110, 158],
          community_events: [18, 47],
          discharge_complaints: [533, 666],
          quality_of_care: [1200, 1264],
          autonomy_rights: [540, 559],
          facility_policies: [330, 345]
        },
        notes: {
          cases: "Example values for testing the visuals.",
          rcc_nf: "Example values for testing the visuals.",
          complaints: "Example values for testing the visuals."
        }
      }
    };

    let repChartMode = "cases";

    function repDeltaText(a, b){
      if(a === 0 && b === 0) return { text: "No change", cls: "" };
      if(a === 0 && b !== 0) return { text: "New reporting", cls: "up" };
      const pct = ((b - a) / Math.abs(a)) * 100;
      const sign = pct >= 0 ? "+" : "";
      const cls = pct >= 0 ? "up" : "down";
      return { text: `${sign}${pct.toFixed(1)}%`, cls };
    }

    function repFmt(n){
      if(n === null || n === undefined) return "n/a";
      if(typeof n !== "number") return String(n);
      return n.toLocaleString();
    }

    function repMakeKpi(title, v2023, v2024, suffix){
      const d = repDeltaText(v2023, v2024);
      const k = document.createElement("div");
      k.className = "kpi tilt";
      k.innerHTML = `
        <div class="kpiTitle">${escapeHtml(title)}</div>
        <div class="kpiValue">${escapeHtml(repFmt(v2024))}${suffix ? escapeHtml(suffix) : ""}</div>
        <div class="kpiDelta ${escapeHtml(d.cls)}">Change: ${escapeHtml(d.text)}</div>
        <div class="subtle" style="margin-top:6px;">FFY 2023: ${escapeHtml(repFmt(v2023))}${suffix ? escapeHtml(suffix) : ""}</div>
      `;
      attachTilt(k);
      return k;
    }

    function repApplyPreset(){
      rep.statusEl.textContent = "Ready";
      toast("Dashboard", "Preset loaded.");
      repRenderAll();
    }

    function repGetActive(){
      return repPresets[rep.presetEl.value] || repPresets.annual;
    }

    function repRenderKpis(){
      const active = repGetActive();
      const d = active.data;
      const focus = rep.focusEl.value;

      rep.kpiGrid.innerHTML = "";

      const blocks = [
        { key:"cases", title:"Cases", v23:d.cases[0], v24:d.cases[1], focus:["all","cases"] },
        { key:"discharge", title:"Discharge complaints", v23:d.discharge_complaints[0], v24:d.discharge_complaints[1], focus:["all","complaints"] },
        { key:"fte", title:"Staff FTE", v23:d.fte[0], v24:d.fte[1], focus:["all","resources"] },
        { key:"resolved", title:"Resolved rate", v23:Math.round(d.resolved_pct[0]*100), v24:Math.round(d.resolved_pct[1]*100), suffix:"%", focus:["all","complaints"] },
        { key:"visits", title:"Facility visits", v23:d.visits[0], v24:d.visits[1], focus:["all","reach"] },
        { key:"events", title:"Community education events", v23:d.community_events[0], v24:d.community_events[1], focus:["all","reach"] },
        { key:"routine", title:"Facilities with routine access", v23:d.routine_access[0], v24:d.routine_access[1], focus:["all","reach"] },
        { key:"volhrs", title:"Volunteer hours", v23:d.volunteer_hours[0], v24:d.volunteer_hours[1], focus:["all","resources"] }
      ];

      blocks
        .filter(b => b.focus.includes(focus))
        .forEach(b => rep.kpiGrid.appendChild(repMakeKpi(b.title, b.v23, b.v24, b.suffix || "")));
    }

    function repDrawBars(canvas, labels, valuesA, valuesB, opts){
      const ctx = canvas.getContext("2d");
      const W = canvas.width;
      const H = canvas.height;

      const bg = "rgba(255,255,255,0.03)";
      const grid = "rgba(148,163,184,0.20)";
      const text = "rgba(229,231,235,0.82)";
      const muted = "rgba(229,231,235,0.62)";
      const cA = "rgba(148,163,184,0.65)";
      const cB = "rgba(56,189,248,0.92)";

      ctx.clearRect(0,0,W,H);

      // background
      ctx.fillStyle = bg;
      ctx.fillRect(0,0,W,H);

      const pad = 46;
      const left = 60;
      const right = 18;
      const top = 18;
      const bottom = 40;

      const plotW = W - left - right;
      const plotH = H - top - bottom;

      const maxVal = Math.max(1, ...valuesA, ...valuesB) * 1.12;

      // grid lines
      ctx.strokeStyle = grid;
      ctx.lineWidth = 1;
      ctx.font = "12px ui-sans-serif, system-ui, Arial";
      for(let i=0;i<=4;i++){
        const y = top + (plotH * (i/4));
        ctx.beginPath();
        ctx.moveTo(left, y);
        ctx.lineTo(left+plotW, y);
        ctx.stroke();

        const labelVal = maxVal * (1 - i/4);
        ctx.fillStyle = muted;
        ctx.fillText(repFmt(Math.round(labelVal)), 10, y+4);
      }

      const groupCount = labels.length;
      const groupGap = 18;
      const groupW = (plotW - groupGap*(groupCount-1)) / groupCount;
      const barGap = 8;
      const barW = (groupW - barGap) / 2;

      function yFor(v){
        return top + plotH - (v / maxVal) * plotH;
      }

      for(let i=0;i<groupCount;i++){
        const gx = left + i*(groupW + groupGap);
        const a = valuesA[i];
        const b = valuesB[i];

        const yA = yFor(a);
        const hA = top + plotH - yA;

        const yB = yFor(b);
        const hB = top + plotH - yB;

        // bar A
        ctx.fillStyle = cA;
        ctx.fillRect(gx, yA, barW, hA);

        // bar B
        ctx.fillStyle = cB;
        ctx.fillRect(gx + barW + barGap, yB, barW, hB);

        // labels
        ctx.fillStyle = text;
        ctx.font = "12px ui-sans-serif, system-ui, Arial";
        ctx.fillText(labels[i], gx, top + plotH + 26);

        // value labels
        ctx.fillStyle = muted;
        ctx.fillText(repFmt(a), gx, yA - 6);
        ctx.fillStyle = text;
        ctx.fillText(repFmt(b), gx + barW + barGap, yB - 6);
      }

      // legend
      ctx.fillStyle = cA;
      ctx.fillRect(left, H-18, 10, 10);
      ctx.fillStyle = muted;
      ctx.fillText(opts.legendA || "FFY 2023", left+16, H-9);

      ctx.fillStyle = cB;
      ctx.fillRect(left+120, H-18, 10, 10);
      ctx.fillStyle = muted;
      ctx.fillText(opts.legendB || "FFY 2024", left+136, H-9);
    }

    function repSetChart(mode){
      repChartMode = mode;
      repRenderChart();
      toast("Dashboard", "Chart updated.");
    }

    function repRenderChart(){
      const active = repGetActive();
      const d = active.data;

      if(repChartMode === "cases"){
        rep.chartTitle1.textContent = "Cases";
        rep.chartSub1.textContent = "FFY 2023 vs FFY 2024";
        repDrawBars(rep.chart1, d.years, d.cases, d.cases, { legendA:"FFY 2023", legendB:"FFY 2024" });
        // Above draws identical series if we pass same arrays twice, so instead draw single group with two bars:
        repDrawBars(rep.chart1, ["Total cases"], [d.cases[0]], [d.cases[1]], { legendA:"FFY 2023", legendB:"FFY 2024" });
        rep.chartNote1.textContent = active.notes.cases;
        repRenderInsights();
        return;
      }

      if(repChartMode === "rcc_nf"){
        rep.chartTitle1.textContent = "Cases by setting";
        rep.chartSub1.textContent = "Nursing facility vs residential care";
        repDrawBars(rep.chart1, ["Nursing facilities", "Residential care"], [d.nf_cases[0], d.rcc_cases[0]], [d.nf_cases[1], d.rcc_cases[1]], { legendA:"FFY 2023", legendB:"FFY 2024" });
        rep.chartNote1.textContent = active.notes.rcc_nf;
        repRenderInsights();
        return;
      }

      if(repChartMode === "complaints"){
        rep.chartTitle1.textContent = "Top complaint categories";
        rep.chartSub1.textContent = "Counts shown from your draft slide text";
        repDrawBars(
          rep.chart1,
          ["Discharge", "Quality of care", "Autonomy and rights", "Facility policies"],
          [d.discharge_complaints[0], d.quality_of_care[0], d.autonomy_rights[0], d.facility_policies[0]],
          [d.discharge_complaints[1], d.quality_of_care[1], d.autonomy_rights[1], d.facility_policies[1]],
          { legendA:"FFY 2023", legendB:"FFY 2024" }
        );
        rep.chartNote1.textContent = active.notes.complaints;
        repRenderInsights();
        return;
      }
    }

    function repRenderInsights(){
      const active = repGetActive();
      const d = active.data;

      const deltaCases = repDeltaText(d.cases[0], d.cases[1]).text;
      const deltaRcc = repDeltaText(d.rcc_cases[0], d.rcc_cases[1]).text;
      const deltaDis = repDeltaText(d.discharge_complaints[0], d.discharge_complaints[1]).text;
      const res = Math.round((d.resolved_pct[1] || 0) * 100);

      const items = [
        `Total cases changed: ${deltaCases}.`,
        `Residential care cases changed: ${deltaRcc}.`,
        `Discharge complaints changed: ${deltaDis}.`,
        `Resolution rate shown: ${res}% for FFY 2024 (edit if needed).`
      ];

      rep.insightList.innerHTML = items.map(t => `<li>${escapeHtml(t)}</li>`).join("");
    }

    function repAutoSummary(){
      const active = repGetActive();
      const d = active.data;

      const casesDelta = repDeltaText(d.cases[0], d.cases[1]).text;
      const rccDelta = repDeltaText(d.rcc_cases[0], d.rcc_cases[1]).text;
      const disDelta = repDeltaText(d.discharge_complaints[0], d.discharge_complaints[1]).text;
      const res = Math.round((d.resolved_pct[1] || 0) * 100);

      const s = `From FFY 2023 to FFY 2024, total cases changed ${casesDelta}, driven by a residential care shift (${rccDelta}). Discharge related complaints changed ${disDelta}. Even with increased demand, the program maintained a reported resolution rate of about ${res}% in FFY 2024.`;
      rep.summaryEl.value = s;
      toast("Summary", "Drafted.");
    }

    async function repCopySummary(){
      const t = rep.summaryEl.value || "";
      if(!t.trim()){ toast("Summary", "Nothing to copy yet."); return; }
      try{
        await navigator.clipboard.writeText(t);
        toast("Copied", "Summary copied to clipboard.");
      }catch{
        alert("Copy failed on this device. Press and hold to copy manually.");
      }
    }

    function repConfetti(){
      confettiBurst();
      toast("Nice", "Confetti deployed.");
    }

    function repRenderAll(){
      repRenderKpis();
      repRenderChart();
    }

    // First render
    repRenderAll();

    /* =========================
       PPTX export
       ========================= */

    function repPptColors(){
      return {
        bg: "020617",
        surface: "0F172A",
        card: "1E293B",
        text: "F1F5F9",
        muted: "CBD5E1",
        accent: "38BDF8",
        accent2: "A78BFA",
        ok: "22C55E"
      };
    }

    function repAddHeader(slide, title, subtitle){
      const c = repPptColors();
      slide.addText(title, { x:0.6, y:0.5, w:12.2, h:0.6, fontFace:"Arial", fontSize:34, bold:true, color:c.accent });
      slide.addText(subtitle, { x:0.6, y:1.1, w:12.2, h:0.35, fontFace:"Arial", fontSize:16, color:c.muted });
      slide.addShape(pptx.ShapeType.line, { x:0.6, y:1.55, w:12.2, h:0, line:{ color:c.accent, width:1 }});
    }

    function repAddKpiCard(slide, x, y, w, h, title, value, note){
      const c = repPptColors();
      slide.addShape(pptx.ShapeType.roundRect, { x, y, w, h, fill:{ color:c.card, transparency:10 }, line:{ color:"334155", width:1 }, radius:10 });
      slide.addText(title, { x:x+0.25, y:y+0.2, w:w-0.5, h:0.3, fontFace:"Arial", fontSize:12, color:c.muted, bold:true });
      slide.addText(value, { x:x+0.25, y:y+0.55, w:w-0.5, h:0.6, fontFace:"Arial", fontSize:24, color:c.text, bold:true });
      slide.addText(note, { x:x+0.25, y:y+1.15, w:w-0.5, h:0.35, fontFace:"Arial", fontSize:11, color:c.muted });
    }

    function repAddBar(slide, x, y, w, h, label, vA, vB, maxV){
      const c = repPptColors();
      // frame
      slide.addShape(pptx.ShapeType.roundRect, { x, y, w, h, fill:{ color:c.card, transparency:10 }, line:{ color:"334155", width:1 }, radius:10 });
      slide.addText(label, { x:x+0.25, y:y+0.18, w:w-0.5, h:0.3, fontFace:"Arial", fontSize:12, color:c.muted, bold:true });

      const plotX = x+0.3;
      const plotY = y+0.55;
      const plotW = w-0.6;
      const plotH = h-0.9;

      // baseline
      slide.addShape(pptx.ShapeType.line, { x:plotX, y:plotY+plotH, w:plotW, h:0, line:{ color:"475569", width:1 }});

      const aH = (vA / maxV) * plotH;
      const bH = (vB / maxV) * plotH;

      const barW = (plotW-0.4) / 2;
      const gap = 0.4;

      // FFY 2023
      slide.addShape(pptx.ShapeType.rect, { x:plotX, y:plotY+plotH-aH, w:barW, h:aH, fill:{ color:"94A3B8" }, line:{ color:"94A3B8" }});
      slide.addText(String(vA), { x:plotX, y:plotY+plotH-aH-0.25, w:barW, h:0.25, fontFace:"Arial", fontSize:10, color:c.muted, align:"center" });
      slide.addText("FFY 2023", { x:plotX, y:plotY+plotH+0.05, w:barW, h:0.25, fontFace:"Arial", fontSize:10, color:c.muted, align:"center" });

      // FFY 2024
      slide.addShape(pptx.ShapeType.rect, { x:plotX+barW+gap, y:plotY+plotH-bH, w:barW, h:bH, fill:{ color:c.accent }, line:{ color:c.accent }});
      slide.addText(String(vB), { x:plotX+barW+gap, y:plotY+plotH-bH-0.25, w:barW, h:0.25, fontFace:"Arial", fontSize:10, color:c.text, align:"center" });
      slide.addText("FFY 2024", { x:plotX+barW+gap, y:plotY+plotH+0.05, w:barW, h:0.25, fontFace:"Arial", fontSize:10, color:c.muted, align:"center" });
    }

    async function repDownloadPptx(){
      try{
        rep.statusEl.textContent = "Building PPTX";
        toast("PPTX", "Generating slides...");

        if(typeof PptxGenJS === "undefined"){
          rep.statusEl.textContent = "PPTX library not loaded";
          toast("PPTX", "Library failed to load. Check network access.");
          return;
        }

        const active = repGetActive();
        const d = active.data;
        const c = repPptColors();

        const pptx = new PptxGenJS();
        pptx.layout = "LAYOUT_WIDE";
        pptx.author = "DanBeem";
        pptx.company = "Ombudsman Tools and Resource Lab";

        // Slide 1 title
        let slide = pptx.addSlide();
        slide.background = { color: c.bg };
        slide.addShape(pptx.ShapeType.roundRect, { x:0.6, y:0.7, w:12.2, h:5.6, fill:{ color:c.surface, transparency:0 }, line:{ color:c.surface }, radius:14 });
        slide.addText(active.title, { x:1.1, y:1.6, w:11.2, h:0.8, fontFace:"Arial", fontSize:40, bold:true, color:c.accent });
        slide.addText("Annual Impact Report", { x:1.1, y:2.5, w:11.2, h:0.4, fontFace:"Arial", fontSize:18, color:c.text });
        slide.addText(active.subtitle, { x:1.1, y:3.0, w:11.2, h:0.35, fontFace:"Arial", fontSize:14, color:c.muted });
        slide.addText("Generated from the dashboard prototype", { x:1.1, y:5.6, w:11.2, h:0.3, fontFace:"Arial", fontSize:11, color:c.muted });

        // Slide 2 at a glance
        slide = pptx.addSlide();
        slide.background = { color: c.bg };
        repAddHeader(slide, "At a glance", active.subtitle);

        repAddKpiCard(slide, 0.8, 1.8, 3.0, 1.6, "Cases", String(d.cases[1]), `FFY 2023: ${d.cases[0]}`);
        repAddKpiCard(slide, 4.1, 1.8, 3.0, 1.6, "Facilities", String(d.facilities[1]), `NF: ${d.nf_facilities[1]}  RCC: ${d.rcc_facilities[1]}`);
        repAddKpiCard(slide, 7.4, 1.8, 3.0, 1.6, "Staff FTE", String(d.fte[1]), `FFY 2023: ${d.fte[0]}`);

        const resPct = Math.round((d.resolved_pct[1] || 0) * 100);
        repAddKpiCard(slide, 10.7, 1.8, 2.3, 1.6, "Resolved", `${resPct}%`, "Partially or fully");

        // Summary text from dashboard
        const sum = (rep.summaryEl.value || "").trim() || "Add a one sentence summary in the dashboard before exporting.";
        slide.addShape(pptx.ShapeType.roundRect, { x:0.8, y:3.7, w:12.2, h:2.3, fill:{ color:c.card, transparency:10 }, line:{ color:"334155", width:1 }, radius:14 });
        slide.addText("Summary", { x:1.1, y:3.9, w:11.6, h:0.3, fontFace:"Arial", fontSize:12, bold:true, color:c.muted });
        slide.addText(sum, { x:1.1, y:4.25, w:11.6, h:1.7, fontFace:"Arial", fontSize:16, color:c.text });

        // Slide 3 charts
        slide = pptx.addSlide();
        slide.background = { color: c.bg };
        repAddHeader(slide, "Key comparisons", active.subtitle);

        const maxCases = Math.max(d.cases[0], d.cases[1]) * 1.15;
        repAddBar(slide, 0.8, 1.8, 4.0, 4.8, "Total cases", d.cases[0], d.cases[1], maxCases);

        const maxRcc = Math.max(d.rcc_cases[0], d.rcc_cases[1], d.nf_cases[0], d.nf_cases[1]) * 1.15;
        repAddBar(slide, 5.05, 1.8, 4.0, 4.8, "Residential care cases", d.rcc_cases[0], d.rcc_cases[1], maxRcc);
        repAddBar(slide, 9.3, 1.8, 3.7, 4.8, "Discharge complaints", d.discharge_complaints[0], d.discharge_complaints[1], Math.max(d.discharge_complaints[0], d.discharge_complaints[1]) * 1.2);

        // Slide 4 thank you
        slide = pptx.addSlide();
        slide.background = { color: c.bg };
        slide.addText("Connecticut Long Term Care Ombudsman Program", { x:0.8, y:2.2, w:12.6, h:0.8, fontFace:"Arial", fontSize:30, bold:true, color:c.accent });
        slide.addText(active.subtitle, { x:0.8, y:3.05, w:12.6, h:0.4, fontFace:"Arial", fontSize:16, color:c.muted });
        slide.addShape(pptx.ShapeType.roundRect, { x:0.8, y:3.8, w:12.6, h:1.8, fill:{ color:c.surface, transparency:0 }, line:{ color:c.surface }, radius:14 });
        slide.addText("This deck was generated from a dashboard prototype. Replace placeholder values with official annual report figures before publication.", { x:1.2, y:4.1, w:11.8, h:1.2, fontFace:"Arial", fontSize:14, color:c.text });

        // Save
        const fname = `CT_LTCOP_Impact_Report_${new Date().toISOString().slice(0,10)}.pptx`;
        await pptx.writeFile({ fileName: fname });

        rep.statusEl.textContent = "Downloaded";
        toast("PPTX", "Download started.");
      } catch (e){
        console.error(e);
        rep.statusEl.textContent = "PPTX error";
        toast("PPTX", "Could not generate PPTX on this browser.");
      }
    }

    /* =========================
       Chain Snapshot (kept from your version)
       ========================= */

    const csEls = {
      ccn: document.getElementById("csCcn"),
      status: document.getElementById("csStatus"),
      facility: document.getElementById("csFacility"),
      chain: document.getElementById("csChain"),
      rights: document.getElementById("csRightsList"),
      pbjStart: document.getElementById("csPbjStart"),
      pbjEnd: document.getElementById("csPbjEnd"),
      pbjResults: document.getElementById("csPbjResults"),
      tabSummary: document.getElementById("csTabSummary"),
      tabRights: document.getElementById("csTabRights"),
      tabPbj: document.getElementById("csTabPbj"),
      panelSummary: document.getElementById("csPanelSummary"),
      panelRights: document.getElementById("csPanelRights"),
      panelPbj: document.getElementById("csPanelPbj"),
    };

    const csDatasetCache = new Map();
    const csDatasetUrlCache = new Map();

    function csNormalizeCcn(v){ return String(v || "").trim(); }
    function csSetStatus(text){ csEls.status.textContent = text; }

    function csSetTab(which){
      const isSummary = which === "summary";
      const isRights = which === "rights";
      const isPbj = which === "pbj";

      csEls.tabSummary.classList.toggle("active", isSummary);
      csEls.tabRights.classList.toggle("active", isRights);
      csEls.tabPbj.classList.toggle("active", isPbj);

      csEls.panelSummary.classList.toggle("hidden", !isSummary);
      csEls.panelRights.classList.toggle("hidden", !isRights);
      csEls.panelPbj.classList.toggle("hidden", !isPbj);
    }
    csSetTab("pbj");

    function csGetFirstValue(row, fields){
      for (const field of fields){
        if (row && row[field] !== undefined && row[field] !== null && row[field] !== ""){
          return row[field];
        }
      }
      return null;
    }

    async function csFetchDatasetCatalog(){
      if (csDatasetCache.has("catalog")) return csDatasetCache.get("catalog");
      const response = await fetch("https://data.cms.gov/data.json");
      if(!response.ok) throw new Error("Failed to load CMS catalog.");
      const data = await response.json();
      csDatasetCache.set("catalog", data);
      return data;
    }

    async function csFindDatasetUrl(title){
      if (csDatasetUrlCache.has(title)) return csDatasetUrlCache.get(title);

      const catalog = await csFetchDatasetCatalog();
      const dataset = (catalog.dataset || []).find((entry) => entry.title === title);
      if (!dataset) return null;

      const distribution = dataset.distribution || [];
      const access =
        distribution.find((item) => item.accessURL)?.accessURL ||
        distribution.find((item) => item.downloadURL)?.downloadURL ||
        distribution[0]?.accessURL ||
        distribution[0]?.downloadURL ||
        null;

      if (access) csDatasetUrlCache.set(title, access);
      return access;
    }

    async function csFetchJson(url){
      if(!url) return [];
      const response = await fetch(url);
      if(!response.ok) throw new Error("Request failed.");
      return response.json();
    }

    function csBuildSocrataUrl(baseUrl, params){
      if(!baseUrl) return null;
      const url = new URL(baseUrl);
      Object.entries(params).forEach(([key, value])=>{
        if (value !== null && value !== undefined && value !== "") url.searchParams.set(key, value);
      });
      return url.toString();
    }

    function csFormatStars(value){
      if (value === null || value === undefined || value === "") return "Not reported";
      return `${value} ‚òÖ`;
    }

    function csFormatAddress(row){
      const street = csGetFirstValue(row, ["address", "street_address", "provider_address", "provider_address_1"]);
      const city = csGetFirstValue(row, ["city", "provider_city"]);
      const state = csGetFirstValue(row, ["state", "provider_state"]);
      const zip = csGetFirstValue(row, ["zip", "zip_code", "provider_zip_code", "provider_zip"]);
      return [street, city, state, zip].filter(Boolean).join(", ");
    }

    function csRenderFacilitySummary(row){
      if (!row){
        csEls.facility.innerHTML = "<h4 style='margin:0 0 8px;'>Facility Summary</h4><p>No facility found for that CCN.</p>";
        return;
      }
      const name = csGetFirstValue(row, ["provider_name", "facility_name", "name"]);
      const overall = csFormatStars(csGetFirstValue(row, ["overall_rating", "overall_star_rating", "overall_rating_value"]));
      const staffing = csFormatStars(csGetFirstValue(row, ["staffing_rating", "staffing_star_rating"]));
      const health = csFormatStars(csGetFirstValue(row, ["health_inspection_rating", "health_inspection_star_rating"]));
      const quality = csFormatStars(csGetFirstValue(row, ["quality_measure_rating", "quality_star_rating", "quality_measure_star_rating"]));
      const rnHprd = csGetFirstValue(row, ["rn_hours_per_resident_day", "rn_hprd"]);
      const totalHprd = csGetFirstValue(row, ["total_nurse_hours_per_resident_day", "total_nurse_hprd"]);

      csEls.facility.innerHTML = `
        <h4 style="margin:0 0 8px;">Facility Summary</h4>
        <p><strong>${escapeHtml(name || "Unknown facility")}</strong></p>
        <p>${escapeHtml(csFormatAddress(row) || "Address not available")}</p>
        <p>Overall rating: ${escapeHtml(overall)}</p>
        <p>Staffing rating: ${escapeHtml(staffing)}</p>
        <p>Health inspection rating: ${escapeHtml(health)}</p>
        <p>Quality measure rating: ${escapeHtml(quality)}</p>
        <p>RN hours per resident day: ${escapeHtml(rnHprd ?? "Not reported")}</p>
        <p>Total nurse hours per resident day: ${escapeHtml(totalHprd ?? "Not reported")}</p>
      `;
    }

    function csRenderChainSummary(row){
      if (!row){
        csEls.chain.innerHTML = "<h4 style='margin:0 0 8px;'>Chain Summary</h4><p>No chain data available.</p>";
        return;
      }
      const chainName = csGetFirstValue(row, ["chain_name", "affiliated_entity_name", "organization_name"]);
      const chainStaffing = csGetFirstValue(row, ["average_staffing_rating", "chain_avg_staffing_rating", "average_staffing_star_rating"]);
      csEls.chain.innerHTML = `
        <h4 style="margin:0 0 8px;">Chain Summary</h4>
        <p><strong>${escapeHtml(chainName || "Unknown chain")}</strong></p>
        <p>Chain average staffing: ${escapeHtml(chainStaffing ?? "Not reported")}</p>
      `;
    }

    function csRenderRights(items){
      if (!items || items.length === 0){
        csEls.rights.innerHTML = "<li>No Resident Rights tags found.</li>";
        return;
      }
      csEls.rights.innerHTML = items.map((item)=>{
        const tag = csGetFirstValue(item, ["f_tag", "tag_code", "deficiency_tag"]);
        const date = csGetFirstValue(item, ["survey_date", "deficiency_date", "inspection_date", "date"]);
        const scope = csGetFirstValue(item, ["scope_severity", "scope_severity_code"]);
        const description = csGetFirstValue(item, ["deficiency_description", "description"]);
        return `<li><strong>${escapeHtml(tag || "Tag")}:</strong> ${escapeHtml(date || "Unknown date")} | ${escapeHtml(scope || "Scope n/a")}<br>${escapeHtml(description || "Description unavailable.")}</li>`;
      }).join("");
    }

    function csRenderPbjResults(payload){
      csEls.pbjResults.innerHTML = `
        <p>Days included: ${payload.days}</p>
        <p>Total census: ${payload.totalCensus}</p>
        <p>RN hours: ${payload.totalRn}</p>
        <p>LPN hours: ${payload.totalLpn}</p>
        <p>CNA hours: ${payload.totalCna}</p>
        <p><strong>Total nursing HPRD:</strong> ${payload.hprd}</p>
      `;
    }

    function csClear(){
      csEls.ccn.value = "";
      csSetStatus("Awaiting query");
      csEls.facility.innerHTML = "<h4 style='margin:0 0 8px;'>Facility Summary</h4><p>Run a CCN to populate details.</p>";
      csEls.chain.innerHTML = "<h4 style='margin:0 0 8px;'>Chain Summary</h4><p>Chain details will appear here when available.</p>";
      csEls.rights.innerHTML = "<li>Run a CCN to populate results.</li>";
      csEls.pbjResults.innerHTML = "<p>Choose a date range and run to see PBJ totals.</p>";
      toast("Chain Snapshot", "Cleared.");
    }

    async function csRun(){
      const ccn = csNormalizeCcn(csEls.ccn.value);
      if(!ccn){
        csSetStatus("Enter a CCN first.");
        toast("Chain Snapshot", "Enter a CCN first.");
        return;
      }

      csSetStatus("Loading datasets...");
      csEls.facility.innerHTML = "<h4 style='margin:0 0 8px;'>Facility Summary</h4><p>Loading...</p>";
      csEls.chain.innerHTML = "<h4 style='margin:0 0 8px;'>Chain Summary</h4><p>Loading...</p>";
      csEls.rights.innerHTML = "<li>Loading...</li>";
      csEls.pbjResults.innerHTML = "<p>Loading...</p>";

      try{
        const providerUrl = await csFindDatasetUrl("Provider Information");
        const deficienciesUrl = await csFindDatasetUrl("Health Deficiencies");
        const chainUrl = await csFindDatasetUrl("Nursing Home Chain Performance Measures");
        const pbjUrl = await csFindDatasetUrl("Payroll Based Journal Daily Nurse Staffing");

        const providerQuery = csBuildSocrataUrl(providerUrl, {
          $limit: 5,
          $where: `provider_ccn='${ccn}' OR federal_provider_number='${ccn}' OR ccn='${ccn}'`,
        });
        const providerRows = await csFetchJson(providerQuery);
        const providerRow = providerRows?.[0] || null;
        csRenderFacilitySummary(providerRow);

        const chainId = csGetFirstValue(providerRow || {}, ["chain_id", "affiliated_entity_id", "ownership_id", "corporate_chain_id"]);
        if (chainId && chainUrl){
          const chainQuery = csBuildSocrataUrl(chainUrl, {
            $limit: 5,
            $where: `chain_id='${chainId}' OR affiliated_entity_id='${chainId}'`,
          });
          const chainRows = await csFetchJson(chainQuery);
          csRenderChainSummary(chainRows?.[0] || null);
        } else {
          csRenderChainSummary(null);
        }

        if (deficienciesUrl){
          const deficiencyQuery = csBuildSocrataUrl(deficienciesUrl, {
            $limit: 200,
            $where: `provider_ccn='${ccn}' OR federal_provider_number='${ccn}'`,
            $order: "survey_date DESC",
          });
          const deficiencyRows = await csFetchJson(deficiencyQuery);
          const rights = (deficiencyRows || []).filter((row)=>{
            const tag = (csGetFirstValue(row, ["f_tag", "tag_code", "deficiency_tag"]) || "").toUpperCase();
            return tag.startsWith("F");
          });
          csRenderRights(rights.slice(0, 25));
        } else {
          csRenderRights([]);
        }

        const start = csEls.pbjStart.value;
        const end = csEls.pbjEnd.value;

        if (pbjUrl && start && end){
          const pbjQuery = csBuildSocrataUrl(pbjUrl, {
            $limit: 50000,
            $where: `provider_ccn='${ccn}' AND work_date between '${start}' and '${end}'`,
          });
          const pbjRows = await csFetchJson(pbjQuery);

          const totals = (pbjRows || []).reduce((acc, row)=>{
            const census = Number(csGetFirstValue(row, ["census", "resident_count", "total_census"])) || 0;
            const rn = Number(csGetFirstValue(row, ["rn_hours", "registered_nurse_hours"])) || 0;
            const lpn = Number(csGetFirstValue(row, ["lpn_hours", "licensed_practical_nurse_hours"])) || 0;
            const cna = Number(csGetFirstValue(row, ["cna_hours", "certified_nurse_aide_hours"])) || 0;

            acc.totalCensus += census;
            acc.totalRn += rn;
            acc.totalLpn += lpn;
            acc.totalCna += cna;
            if (census > 0) acc.days += 1;
            return acc;
          }, { days: 0, totalCensus: 0, totalRn: 0, totalLpn: 0, totalCna: 0 });

          const totalHours = totals.totalRn + totals.totalLpn + totals.totalCna;
          const hprd = totals.totalCensus > 0 ? (totalHours / totals.totalCensus).toFixed(2) : "0.00";
          csRenderPbjResults({ ...totals, hprd });
        } else {
          csEls.pbjResults.innerHTML = "<p>Provide a date range to compute PBJ totals.</p>";
        }

        csSetStatus("Snapshot ready");
        toast("Chain Snapshot", "Snapshot ready.");
      } catch (err){
        console.error(err);
        csSetStatus("Error loading data");
        csEls.facility.innerHTML = "<h4 style='margin:0 0 8px;'>Facility Summary</h4><p>Unable to load data.</p>";
        csEls.chain.innerHTML = "<h4 style='margin:0 0 8px;'>Chain Summary</h4><p>Unable to load data.</p>";
        csEls.rights.innerHTML = "<li>Unable to load data.</li>";
        csEls.pbjResults.innerHTML = "<p>Unable to load data.</p>";
        toast("Chain Snapshot", "Error loading data.");
      }
    }
  </script>
</body>
</html>
