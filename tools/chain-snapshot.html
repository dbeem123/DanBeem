<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chain Snapshot Tool (Test)</title>
  <link rel="stylesheet" href="../Assets/shared.css">
  <style>
    .tab-button { display: none; }
    .tab-button:checked + .tab-label { background: rgba(255,255,255,0.08); border-color: rgba(56,189,248,0.25); color: var(--accent); }
    .tab-label { display: inline-block; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; font-weight: 700; transition: all 140ms; }
    .tab-content { display: none; }
    .tab-button:checked + .tab-label + .tab-content { display: block; }
    .input-group { margin-bottom: 12px; }
    .input-group label { display: block; font-weight: 700; margin-bottom: 6px; color: var(--text); }
    input[type="text"], input[type="number"] { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; background: rgba(255,255,255,0.02); color: var(--text); font-family: inherit; }
    input::placeholder { color: rgba(230,240,252,0.35); }
    .search-results { margin-top: 12px; max-height: 240px; overflow-y: auto; }
    .search-result { padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; cursor: pointer; background: rgba(255,255,255,0.01); transition: background 120ms; }
    .search-result:hover { background: rgba(255,255,255,0.03); }
    .error-msg { background: rgba(251,113,133,0.08); border: 1px solid rgba(251,113,133,0.18); color: #fca5ac; padding: 10px 12px; border-radius: 8px; margin-bottom: 12px; }
    .success-msg { background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.18); color: #86efac; padding: 10px 12px; border-radius: 8px; margin-bottom: 12px; }
    .info-box { background: rgba(255,255,255,0.01); border: 1px solid var(--border); padding: 12px; border-radius: 8px; margin-top: 8px; }
    .info-label { font-weight: 700; color: rgba(230,240,252,0.7); font-size: 12px; }
    .info-value { color: var(--text); font-weight: 600; margin-top: 4px; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="wrap space-between">
      <div class="brand">
        <div class="logo">DB</div>
        <div style="margin-left:8px;">
          <div style="font-weight:800">Chain Snapshot</div>
          <div class="subtle" style="font-size:12px;">Facility Data Tool</div>
        </div>
      </div>
      <nav class="nav">
        <a class="navLink linkBtn" href="../index.html">Home</a>
        <a class="navLink linkBtn" href="../dashboards/impact-2024.html">Impact Dashboard</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="panel" style="margin-bottom:18px;">
      <div class="pill">Test Environment</div>
      <h1 style="margin-top:8px;">Chain Snapshot</h1>
      <p class="subtle">Query facility data, deficiencies, and chain/ownership signals using CMS APIs. This is a test environment; data sources may change.</p>
    </div>

    <!-- Input Modes: Tabs -->
    <div class="panel">
      <!-- Tab 1: Direct CCN Lookup -->
      <input type="radio" id="tab-direct" name="entry-mode" class="tab-button" checked>
      <label for="tab-direct" class="tab-label">Direct CCN Lookup</label>
      <div class="tab-content">
        <div class="input-group">
          <label for="ccn-input">Enter CCN (10-digit code):</label>
          <input type="text" id="ccn-input" placeholder="e.g., 0001234567" maxlength="10">
        </div>
        <button class="btn" onclick="fetchByCCN()">Fetch Facility Data</button>
        <div id="direct-error"></div>
      </div>

      <!-- Tab 2: Search by Name/City/State -->
      <input type="radio" id="tab-search" name="entry-mode" class="tab-button">
      <label for="tab-search" class="tab-label">Search by Name/City/State</label>
      <div class="tab-content">
        <div class="input-group">
          <label for="facility-name">Facility Name:</label>
          <input type="text" id="facility-name" placeholder="e.g., Sunrise Manor">
        </div>
        <div class="input-group">
          <label for="facility-city">City:</label>
          <input type="text" id="facility-city" placeholder="e.g., Las Vegas">
        </div>
        <div class="input-group">
          <label for="facility-state">State (2-letter):</label>
          <input type="text" id="facility-state" placeholder="e.g., NV" maxlength="2">
        </div>
        <button class="btn" onclick="searchFacilities()">Search Facilities</button>
        <div id="search-error"></div>
        <div id="search-results" class="search-results"></div>
      </div>
    </div>

    <!-- Results Section -->
    <div id="results-section" style="display:none;">
      <!-- Facility Summary -->
      <div class="panel" style="margin-top:18px;">
        <h2>Facility Summary</h2>
        <div id="facility-summary" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));">
          <div class="info-box">
            <div class="info-label">CCN</div>
            <div class="info-value" id="summary-ccn">—</div>
          </div>
          <div class="info-box">
            <div class="info-label">Name</div>
            <div class="info-value" id="summary-name">—</div>
          </div>
          <div class="info-box">
            <div class="info-label">Address</div>
            <div class="info-value" id="summary-address">—</div>
          </div>
          <div class="info-box">
            <div class="info-label">Phone</div>
            <div class="info-value" id="summary-phone">—</div>
          </div>
          <div class="info-box">
            <div class="info-label">Beds</div>
            <div class="info-value" id="summary-beds">—</div>
          </div>
          <div class="info-box">
            <div class="info-label">Type</div>
            <div class="info-value" id="summary-type">—</div>
          </div>
        </div>
      </div>

      <!-- Deficiencies -->
      <div class="panel" style="margin-top:18px;">
        <h2>Recent Deficiencies (F-Tags)</h2>
        <p class="subtle">Most recent violations and issue codes.</p>
        <div id="deficiencies-list" style="margin-top:12px;"></div>
      </div>

      <!-- Ownership / Chain Signals -->
      <div class="panel" style="margin-top:18px;">
        <h2>Ownership & Chain Signals</h2>
        <div id="chain-signals" class="card" style="margin-top:8px;">
          <p class="subtle" style="margin:0;">Ownership structure, parent company, and chain affiliation data will appear here once CMS endpoints are fully configured.</p>
        </div>
      </div>

      <!-- Clear Button -->
      <div style="margin-top:18px;text-align:center;">
        <button class="btn secondary" onclick="clearResults()">Start Over</button>
      </div>
    </div>

    <!-- API Info (collapsible) -->
    <div class="panel" style="margin-top:18px;">
      <details>
        <summary style="font-weight:700;cursor:pointer;">API & Data Source Info</summary>
        <div style="margin-top:12px;font-size:13px;color:var(--muted);">
          <p><strong>Data Sources:</strong></p>
          <ul style="margin:8px 0;padding-left:20px;">
            <li>CMS Provider of Services file (national provider data)</li>
            <li>CMS Detailed Deficiency complaint data</li>
            <li>Ownership and related entity indicators</li>
          </ul>
          <p style="margin-top:12px;"><strong>Note:</strong> This tool attempts to fetch live data from CMS APIs. If data does not load, please check network connectivity and endpoint availability. Some endpoints may require authentication or have CORS restrictions.</p>
        </div>
      </details>
    </div>
  </main>

  <footer class="wrap subtle" style="margin-top:18px;">Test environment — data may be incomplete or subject to change.</footer>

  <script>
    // ===== TAB SWITCHING =====
    function updateTabs() {
      document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
      const checked = document.querySelector('.tab-button:checked');
      if (checked) {
        const label = checked.nextElementSibling;
        const content = label && label.nextElementSibling;
        if (content && content.classList.contains('tab-content')) {
          content.style.display = 'block';
          // Clear any previous errors
          document.querySelectorAll('#direct-error, #search-error').forEach(el => { if (el) el.innerHTML = ''; });
          // Focus first input in content for accessibility
          const firstInput = content.querySelector('input, textarea, button, select');
          if (firstInput) firstInput.focus();
        }
      }
    }

    document.querySelectorAll('.tab-button').forEach(btn => btn.addEventListener('change', updateTabs));
    document.addEventListener('DOMContentLoaded', updateTabs);

    // ===== FACILITY DATA CACHE =====
    let currentFacility = null;

    // ===== DIRECT CCN LOOKUP =====
    async function fetchByCCN() {
      const ccn = document.getElementById('ccn-input').value.trim().toUpperCase();
      const errorDiv = document.getElementById('direct-error');
      errorDiv.innerHTML = '';

      if (!ccn || ccn.length !== 10 || !/^[A-Z0-9]{10}$/.test(ccn)) {
        errorDiv.innerHTML = '<div class="error-msg">Please enter a valid 10-digit CCN (alphanumeric).</div>';
        return;
      }

      try {
        errorDiv.innerHTML = '<div class="info-msg" style="background:rgba(56,189,248,0.08);color:#38bdf8;border:1px solid rgba(56,189,248,0.18);padding:10px 12px;border-radius:8px;">Fetching facility data from CMS...</div>';

        // Fetch from CMS Care Compare API
        const facility = await fetchFacilityFromCMS(ccn);
        
        if (facility) {
          currentFacility = facility;
          displayFacilityData(facility);
          await fetchDeficiencies(ccn);
          document.getElementById('results-section').style.display = 'block';
          errorDiv.innerHTML = '';
        } else {
          errorDiv.innerHTML = '<div class="error-msg">Facility CCN not found in CMS database. Please verify the 10-digit code.</div>';
        }
      } catch (err) {
        errorDiv.innerHTML = `<div class="error-msg"><strong>Error fetching data:</strong> ${err.message}<br><span style="font-size:12px;">This may indicate CMS API unavailability or network issues. Try again or use the search function.</span></div>`;
        console.error('Fetch error:', err);
      }
    }

    // ===== FACILITY SEARCH =====
    async function searchFacilities() {
      const name = document.getElementById('facility-name').value.trim();
      const city = document.getElementById('facility-city').value.trim();
      const state = document.getElementById('facility-state').value.trim().toUpperCase();
      const errorDiv = document.getElementById('search-error');
      const resultsDiv = document.getElementById('search-results');

      errorDiv.innerHTML = '';
      resultsDiv.innerHTML = '';

      if (!name && !city && !state) {
        errorDiv.innerHTML = '<div class="error-msg">Please enter at least one search criterion.</div>';
        return;
      }

      try {
        errorDiv.innerHTML = '<div style="background:rgba(56,189,248,0.08);color:#38bdf8;border:1px solid rgba(56,189,248,0.18);padding:10px 12px;border-radius:8px;">Searching CMS database...</div>';

        // Search CMS Care Compare API
        const results = await searchFacilitiesFromCMS(name, city, state);

        if (results.length === 0) {
          errorDiv.innerHTML = '<div class="error-msg">No facilities found. Try broader search terms or check state abbreviation.</div>';
          return;
        }

        errorDiv.innerHTML = '';
        resultsDiv.innerHTML = results.map(f => `
          <div class="search-result" onclick="selectFacility('${f.ccn}', '${f.name.replace(/'/g, "\\'")}', '${f.city.replace(/'/g, "\\'")}', '${f.state}')">
            <strong>${f.name}</strong><br>
            <span class="subtle">${f.city}, ${f.state} • CCN: ${f.ccn}</span>
          </div>
        `).join('');
      } catch (err) {
        errorDiv.innerHTML = `<div class="error-msg"><strong>Search error:</strong> ${err.message}<br><span style="font-size:12px;">CMS API may be temporarily unavailable. Please try again.</span></div>`;
        console.error('Search error:', err);
      }
    }

    // ===== SELECT FROM SEARCH RESULTS =====
    async function selectFacility(ccn, name, city, state) {
      document.getElementById('ccn-input').value = ccn;
      document.getElementById('facility-name').value = '';
      document.getElementById('facility-city').value = '';
      document.getElementById('facility-state').value = '';
      document.getElementById('search-results').innerHTML = '';

      const facility = {
        ccn: ccn,
        name: name,
        city: city,
        state: state,
        address: `${city}, ${state}`,
        phone: 'N/A',
        beds: 'N/A',
        type: 'Nursing Home'
      };

      currentFacility = facility;
      displayFacilityData(facility);
      await fetchDeficiencies(ccn);
      document.getElementById('results-section').style.display = 'block';
    }

    // ===== DISPLAY FACILITY DATA =====
    function displayFacilityData(facility) {
      document.getElementById('summary-ccn').textContent = facility.ccn;
      document.getElementById('summary-name').textContent = facility.name;
      document.getElementById('summary-address').textContent = facility.address;
      document.getElementById('summary-phone').textContent = facility.phone;
      document.getElementById('summary-beds').textContent = facility.beds;
      document.getElementById('summary-type').textContent = facility.type;
    }

    // ===== FETCH DEFICIENCIES =====
    async function fetchDeficiencies(ccn) {
      const list = document.getElementById('deficiencies-list');
      try {
        const deficiencies = await fetchDeficienciesFromCMS(ccn);
        
        if (deficiencies.length === 0) {
          list.innerHTML = '<p class="subtle">No recent deficiencies found in CMS records.</p>';
          return;
        }

        list.innerHTML = deficiencies.slice(0, 10).map(d => `
          <div class="card" style="margin-bottom:8px;">
            <strong style="color:var(--accent);">F-Tag ${d.ftag || 'N/A'}</strong>
            <p style="margin:4px 0 0;font-size:13px;">${d.description || d.deficiency || 'Deficiency on record'}</p>
            <p class="subtle" style="margin:4px 0 0;">Cited: ${d.date || d.visitDate || 'Date N/A'}</p>
          </div>
        `).join('');
      } catch (err) {
        list.innerHTML = `<p class="error-msg">Could not fetch deficiency data: ${err.message}</p>`;
        console.error('Deficiency fetch error:', err);
      }
    }

    // ===== CLEAR RESULTS =====
    function clearResults() {
      document.getElementById('results-section').style.display = 'none';
      document.getElementById('ccn-input').value = '';
      document.getElementById('facility-name').value = '';
      document.getElementById('facility-city').value = '';
      document.getElementById('facility-state').value = '';
      document.getElementById('search-results').innerHTML = '';
      document.getElementById('direct-error').innerHTML = '';
      document.getElementById('search-error').innerHTML = '';
      currentFacility = null;
    }

    // ===== CMS API INTEGRATION =====
    // Uses Medicare.gov Care Compare API (public, CORS-enabled via proxy)
    // CORS proxy: https://api.allorigins.win

    async function fetchFacilityFromCMS(ccn) {
      // Care Compare API endpoint for nursing home details
      const cmsUrl = `https://data.cms.gov/api/views/homes/rows.json?filter=Provider%20ID%20=${ccn}&limit=1`;
      const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(cmsUrl)}`;
      
      const response = await fetch(proxyUrl);
      if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      
      const proxyData = await response.json();
      if (!proxyData.contents) throw new Error('No data returned from proxy');
      
      const data = JSON.parse(proxyData.contents);
      if (!data || data.length === 0) return null;

      const row = data[0];
      return {
        ccn: row[9] || ccn,  // Provider ID
        name: row[1] || 'Unknown',  // Facility Name
        city: row[4] || 'Unknown',  // City
        state: row[5] || 'Unknown',  // State
        address: `${row[4] || ''}, ${row[5] || ''} ${row[7] || ''}`.trim(),
        phone: row[8] || 'N/A',  // Phone
        beds: row[10] || 'N/A',  // Certified Beds
        type: 'Skilled Nursing Facility'
      };
    }

    async function searchFacilitiesFromCMS(name, city, state) {
      // Search CMS Provider of Services dataset
      let filter = '';
      if (name) filter += `Facility%20Name%20contains%20'${encodeURIComponent(name)}'`;
      if (city) filter += (filter ? '%20AND%20' : '') + `City%20contains%20'${encodeURIComponent(city)}'`;
      if (state) filter += (filter ? '%20AND%20' : '') + `State%20=${encodeURIComponent(state)}`;

      const cmsUrl = `https://data.cms.gov/api/views/homes/rows.json?filter=${filter}&limit=50`;
      const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(cmsUrl)}`;
      
      const response = await fetch(proxyUrl);
      if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      
      const proxyData = await response.json();
      if (!proxyData.contents) throw new Error('No data returned from proxy');
      
      const data = JSON.parse(proxyData.contents);
      if (!data || data.length === 0) return [];

      return data.slice(0, 20).map(row => ({
        ccn: row[9] || 'UNKNOWN',
        name: row[1] || 'Unknown Facility',
        city: row[4] || 'Unknown',
        state: row[5] || 'Unknown'
      }));
    }

    async function fetchDeficienciesFromCMS(ccn) {
      // CMS Enforcement & Inspections API
      // Returns inspection & accusation data
      const cmsUrl = `https://data.cms.gov/api/views/wvyx-sxba/rows.json?filter=Provider%20ID%20=${ccn}&limit=20`;
      const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(cmsUrl)}`;
      
      const response = await fetch(proxyUrl);
      if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      
      const proxyData = await response.json();
      if (!proxyData.contents) throw new Error('No data returned from proxy');
      
      const data = JSON.parse(proxyData.contents);
      if (!data || data.length === 0) return [];

      return data.map(row => ({
        ftag: row[5] || 'N/A',  // F-tag code
        description: row[4] || 'Deficiency noted',  // Deficiency description
        date: row[7] ? new Date(row[7]).toLocaleDateString() : 'N/A'  // Visit date
      }));
    }
  </script>
